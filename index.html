<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --md-primary-color: #1976D2; --md-accent-color: #FFC107; --md-background-color: #F5F5F5;
            --md-surface-color: #FFFFFF; --md-text-primary: #212121; --md-text-secondary: #757575;
            --md-divider-color: #E0E0E0; --md-shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --md-shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--md-background-color); color: var(--md-text-primary); margin: 0; line-height: 1.5; -webkit-font-smoothing: antialiased; }
        .hidden { display: none !important; }

        #login-container { display: flex; justify-content: center; align-items: center; height: 100vh; padding: 16px; }
        .login-card { background: var(--md-surface-color); padding: 24px 32px; border-radius: 8px; box-shadow: var(--md-shadow-2); width: 100%; max-width: 400px; text-align: center; }
        .login-card h1 { color: var(--md-primary-color); margin-bottom: 24px; font-weight: 500; }
        #auth-error { color: #D32F2F; margin-top: 16px; font-size: 14px; min-height: 20px; }
        .form-group { position: relative; margin-bottom: 24px; }
        .form-input { width: 100%; padding: 12px 0 8px 0; border: none; border-bottom: 1px solid var(--md-text-secondary); background: transparent; font-size: 16px; }
        .form-input:focus { outline: none; border-bottom: 2px solid var(--md-primary-color); }
        .form-label { position: absolute; top: 12px; left: 0; font-size: 16px; color: var(--md-text-secondary); pointer-events: none; transition: 0.2s ease all; }
        .form-input:focus ~ .form-label, .form-input:not(:placeholder-shown) ~ .form-label { top: -10px; font-size: 12px; color: var(--md-primary-color); }
        .form-select { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid var(--md-divider-color); border-radius: 4px; background-color: transparent; font-size: 16px; appearance: none; }
        .select-group { position: relative; }
        .select-group::after { content: 'â–¼'; position: absolute; top: 12px; right: 12px; color: var(--md-text-secondary); pointer-events: none; }
        
        .btn { background-color: var(--md-primary-color); color: white; padding: 10px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; text-transform: uppercase; box-shadow: var(--md-shadow-1); transition: box-shadow 0.2s; }
        .btn:hover { box-shadow: var(--md-shadow-2); }
        .btn.secondary { background-color: #757575; }
        .card { background: var(--md-surface-color); padding: 24px; border-radius: 8px; box-shadow: var(--md-shadow-1); margin-bottom: 16px; }
        .card-title { font-size: 18px; font-weight: 500; margin: 0 0 24px 0; }
        /* Settings Menu Style */
        .settings-item { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--md-divider-color); cursor: pointer; }
        .settings-item:hover { background-color: var(--md-background-color); }
        .settings-item svg { margin-right: 24px; color: var(--md-text-secondary); }
        .settings-item span { font-weight: 500; font-size: 16px; }

        #app-container { display: flex; flex-direction: column; min-height: 100vh; }
        .top-app-bar { display: flex; align-items: center; padding: 0 8px; height: 56px; background-color: var(--md-primary-color); color: white; box-shadow: var(--md-shadow-2); position: sticky; top: 0; z-index: 1000; }
        .icon-btn { background: none; border: none; color: white; padding: 12px; border-radius: 50%; cursor: pointer; }
        .app-bar-title { font-size: 20px; font-weight: 500; margin-left: 16px; }
        .nav-drawer { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--md-surface-color); box-shadow: var(--md-shadow-2); z-index: 2000; transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        .nav-drawer.open { transform: translateX(0); }
        .nav-header { padding: 16px; border-bottom: 1px solid var(--md-divider-color); }
        .nav-header h2 { color: var(--md-primary-color); margin: 0; font-weight: 500; }
        .nav-list { list-style: none; padding: 8px 0; margin: 0; flex-grow: 1; }
        .nav-list a { display: flex; align-items: center; padding: 12px 16px; color: var(--md-text-primary); text-decoration: none; font-weight: 500; }
        .nav-list a.active, .nav-list a:hover { background-color: rgba(25, 118, 210, 0.1); }
        .nav-list a svg { margin-right: 24px; color: var(--md-text-secondary); }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; }
        main { padding: 16px; padding-bottom: 72px; flex-grow: 1; }
        .page-content { max-width: 1200px; margin: 0 auto; }
        .page { display: none; }
        .page.active { display: block; }
        
        #salary-widget { position: fixed; bottom: 72px; left: 16px; background: var(--md-surface-color); border-radius: 8px; box-shadow: var(--md-shadow-2); cursor: pointer; z-index: 950; transition: all 0.3s ease; }
        #salary-widget-summary { padding: 8px 12px; display: flex; align-items: center; }
        #salary-widget-summary svg { color: var(--md-primary-color); margin-right: 8px; }
        #salary-widget-summary span { font-weight: 500; }
        #salary-widget-details { max-height: 0; overflow: hidden; padding: 0 12px; transition: max-height 0.3s ease, padding 0.3s ease; }
        #salary-widget.open #salary-widget-details { max-height: 400px; padding: 0 12px 12px 12px; }
        @media (min-width: 768px) { #salary-widget { bottom: 24px; } }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 56px; background: var(--md-surface-color); box-shadow: 0 -1px 3px rgba(0,0,0,0.1); display: flex; z-index: 500; }
        .bottom-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--md-text-secondary); border: none; background: none; cursor: pointer; }
        .bottom-nav-item.active { color: var(--md-primary-color); }
        .bottom-nav-item span { font-size: 12px; margin-top: 2px; }
        @media (min-width: 768px) { .bottom-nav { display: none; } }
        pre { white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>

    <div id="login-container">
        <div class="login-card">
            <h1>Salary Pro</h1>
            <div class="form-group"><input type="email" id="email" class="form-input" placeholder=" " required><label for="email" class="form-label">Email</label></div>
            <div class="form-group"><input type="password" id="password" class="form-input" placeholder=" " required><label for="password" class="form-label">Password</label></div>
            <button id="login-btn" class="btn" style="width:100%;">Login</button>
            <p style="margin: 16px 0; color: var(--md-text-secondary);">OR</p>
            <button id="signup-btn" class="btn secondary" style="width:100%;">Sign Up</button>
            <p id="auth-error"></p>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div id="overlay" class="hidden" onclick="toggleMenu()"></div>
        <div id="side-menu" class="nav-drawer">
            <div class="nav-header"><h2>Salary Pro</h2></div>
            <ul class="nav-list">
                <li><a href="#" class="nav-link" data-page="daily-entry-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg><span>Daily Entry</span></a></li>
                <li><a href="#" class="nav-link" data-page="agreements-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg><span>Agreements</span></a></li>
                <li><a href="#" class="nav-link" data-page="bonus-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg><span>Bonus</span></a></li>
                <li><a href="#" class="nav-link" data-page="arrears-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg><span>Arrears</span></a></li>
                <li><a href="#" class="nav-link" data-page="settings-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg><span>Settings</span></a></li>
            </ul>
            <div style="padding: 16px;"><button id="menu-logout-btn" class="btn secondary" style="width:100%;">Logout</button></div>
        </div>
        <header class="top-app-bar">
            <button id="menu-btn" class="icon-btn" onclick="toggleMenu()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
            <div id="header-title" class="app-bar-title"></div>
        </header>
        <main>
            <div class="page-content">
                <!-- Pages ki nayi tarteeb -->
                <div id="daily-entry-page" class="page"></div>
                <div id="agreements-page" class="page"></div>
                <div id="bonus-page" class="page"></div>
                <div id="arrears-page" class="page"></div>
                <div id="settings-page" class="page"></div>
                <!-- Settings ke liye makhsoos pages -->
                <div id="generate-payroll-page" class="page"></div>
                <div id="manage-workers-page" class="page"></div>
            </div>
        </main>
        <div id="salary-widget" onclick="this.classList.toggle('open')">
            <div id="salary-widget-summary">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 12.58A10 10 0 1 1 4.42 11"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                <span id="widget-summary-text"></span>
            </div>
            <div id="salary-widget-details"></div>
        </div>
        <nav class="bottom-nav">
            <button class="bottom-nav-item" data-page="daily-entry-page"><span>Entry</span></button>
            <button class="bottom-nav-item" data-page="agreements-page"><span>Agreements</span></button>
            <button class="bottom-nav-item" data-page="bonus-page"><span>Bonus</span></button>
        </nav>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAya9Kjvrqrvpm7JuXU7aa_qyBrJKtjLyo",
            authDomain: "salary-d19b0.firebaseapp.com",
            databaseURL: "https://salary-d19b0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "salary-d19b0",
            storageBucket: "salary-d19b0.appspot.com",
            messagingSenderId: "572149024584",
            appId: "1:572149024584:web:bbd70fc34d2ef11679d57d"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let workerList = [];
        let appConfig = { rates: null };

        // AUTHENTICATION & INITIALIZATION
        document.getElementById('login-btn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(err => document.getElementById('auth-error').textContent = err.message));
        document.getElementById('signup-btn').addEventListener('click', () => auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(err => document.getElementById('auth-error').textContent = err.message));

        auth.onAuthStateChanged(async user => {
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.body.style.cursor = 'wait';
                await initializeApp();
                document.body.style.cursor = 'default';
            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appConfig.rates = null;
                workerList = [];
            }
        });
        
        async function initializeApp() {
            setupAppListeners();
            await loadWorkers(); 
            await loadAgreements();
            showPage('daily-entry-page');
            updateSalaryWidget();
        }
        
        function setupAppListeners() {
            document.querySelectorAll('.nav-link, .bottom-nav-item').forEach(link => {
                if(!link.getAttribute('listener-added')) {
                    link.addEventListener('click', (e) => { e.preventDefault(); showPage(link.dataset.page); });
                    link.setAttribute('listener-added', 'true');
                }
            });
            document.getElementById('menu-logout-btn').addEventListener('click', () => auth.signOut());
        }

        async function loadWorkers() {
            const uid = auth.currentUser.uid;
            const defaultWorkers = ["Khushi", "Anwar", "Mumtaz", "Ameer", "Nawaz", "Hussain", "Latif", "Rabdina"];
            try {
                const snapshot = await database.ref(`workers/${uid}`).once('value');
                if (snapshot.exists()) {
                    workerList = snapshot.val();
                    if(!Array.isArray(workerList)) throw new Error("Worker data is not an array");
                } else {
                    await database.ref(`workers/${uid}`).set(defaultWorkers);
                    workerList = defaultWorkers;
                }
            } catch (error) {
                console.error("Error loading workers:", error.message);
                workerList = defaultWorkers;
                 // Agar error ho to default set karke aage barhein
            }
        }
        
        async function saveWorkerNames() {
            const newWorkerNames = [];
            const workerInputs = document.querySelectorAll('#manage-workers-page .form-input');
            workerInputs.forEach(input => {
                const newName = input.value.trim();
                 if (newName) {
                    newWorkerNames.push(newName);
                }
            });
            
            if (newWorkerNames.length === 0) {
                 alert('At least one worker name is required!');
                 return;
            }

            const uid = auth.currentUser.uid;
            try {
                await database.ref(`workers/${uid}`).set(newWorkerNames);
                await loadWorkers(); // Database se updated list dobara load karein
                alert('Worker names have been saved successfully!');
                showPage('manage-workers-page', 'Manage Workers'); // Page ko refresh karein
            } catch (error) {
                alert('Error saving names: ' + error.message);
            }
        }
        
        async function loadAgreements() {
            const uid = auth.currentUser.uid;
            const snapshot = await database.ref(`agreements/${uid}`).once('value');
            if (snapshot.exists()) {
                appConfig.rates = snapshot.val();
            } else {
                const defaultAgreements = {
                    current: { tonRate: 22, restRate: 1100, layoffRate: 549, allowance: 10000 },
                    new: { tonRate: 22, restRate: 1100, layoffRate: 549, allowance: 13000 }
                };
                await database.ref(`agreements/${uid}`).set(defaultAgreements);
                appConfig.rates = defaultAgreements;
            }
        }
        
        async function saveAgreement(type) {
            const uid = auth.currentUser.uid;
            const data = {
                tonRate: parseFloat(document.getElementById(`${type}TonRate`).value),
                restRate: parseFloat(document.getElementById(`${type}RestRate`).value),
                layoffRate: parseFloat(document.getElementById(`${type}LayoffRate`).value),
                allowance: parseFloat(document.getElementById(`${type}Allowance`).value)
            };
            await database.ref(`agreements/${uid}/${type}`).update(data);
            alert(`${type.charAt(0).toUpperCase() + type.slice(1)} Agreement saved!`);
            await loadAgreements();
            updateSalaryWidget();
        }

        // --- UPDATED showPage FUNCTION ---
        function showPage(pageId, customTitle) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            
            // Highlight logic: 'settings-page' ke sub-pages ke liye bhi 'Settings' ko active rakhein
            const mainPageId = pageId.startsWith('generate-payroll') || pageId.startsWith('manage-workers') ? 'settings-page' : pageId;
            const pageLink = document.querySelector(`.nav-link[data-page="${mainPageId}"]`);

            document.getElementById('header-title').textContent = customTitle || (pageLink ? pageLink.querySelector('span').textContent : 'Salary Pro');
            
            document.querySelectorAll('.nav-link, .bottom-nav-item').forEach(link => {
                link.classList.toggle('active', link.dataset.page === mainPageId);
            });
            
            renderPageContent(pageId);
            targetPage.classList.add('active');
            if(document.getElementById('side-menu').classList.contains('open')) toggleMenu();
        }
        
        // --- UPDATED renderPageContent FUNCTION ---
        function renderPageContent(pageId) {
            const container = document.getElementById(pageId);
            if (!appConfig.rates || !workerList || workerList.length === 0) { 
                container.innerHTML = `<div class="card">Loading App Data...</div>`; return; 
            }
            let content = '';
            switch(pageId) {
                case 'daily-entry-page':
                    content = `<div class="grid-layout">
                        <div class="card">
                            <h2 class="card-title">Daily Work Record</h2>
                            <input type="date" id="entryDate" class="form-select">
                            <div class="select-group"><select id="dayType" class="form-select"><option value="work">Work Day</option><option value="rest">Rest Day</option><option value="special_overtime">Special Overtime</option></select></div>
                            <div id="tonnage-section" class="form-group"><input type="number" id="tonnage" class="form-input" placeholder=" " required><label for="tonnage" class="form-label">Total Tonnage</label></div>
                            <h3 style="font-size: 16px; font-weight: 500; margin-top:24px;">Worker Attendance</h3>
                            <ul style="list-style:none; padding:0; max-height:200px; overflow-y:auto;">${workerList.map(w => `<li><label style="display:flex; align-items:center; width:100%;"><input type="checkbox" class="worker-checkbox" checked value="${w}"> <span style="margin-left:8px;">${w}</span></label></li>`).join('')}</ul>
                            <button class="btn" onclick="calculateAndSave()" style="width:100%; margin-top: 16px;">Calculate & Save</button>
                            <pre id="result-daily" style="margin-top:16px; font-weight:500;"></pre>
                        </div>
                        <div class="card" id="history-card-for-desktop">
                           <h2 class="card-title">Daily History</h2>
                           <div class="select-group" style="margin-bottom: 16px;">
                               <select id="historyPeriodSelect" class="form-select" title="Select period to view history"></select>
                           </div>
                           <div id="history-table-container"></div>
                        </div></div>`;
                    container.innerHTML = content;
                    document.getElementById('entryDate').valueAsDate = new Date();
                    document.getElementById('dayType').addEventListener('change', () => document.getElementById('tonnage-section').style.display = document.getElementById('dayType').value === 'rest' ? 'none' : 'block');
                    initializeHistoryView(); 
                    break;
                case 'agreements-page':
                    content = `<div class="grid-layout">
                        <div class="card"><h2 class="card-title">Current Agreement</h2>
                            <div class="form-group"><input type="number" id="currentTonRate" value="${appConfig.rates.current.tonRate}" class="form-input" placeholder=" "><label class="form-label">Ton Rate</label></div>
                            <div class="form-group"><input type="number" id="currentRestRate" value="${appConfig.rates.current.restRate}" class="form-input" placeholder=" "><label class="form-label">Rest Rate</label></div>
                            <div class="form-group"><input type="number" id="currentLayoffRate" value="${appConfig.rates.current.layoffRate}" class="form-input" placeholder=" "><label class="form-label">Layoff Rate</label></div>
                            <div class="form-group"><input type="number" id="currentAllowance" value="${appConfig.rates.current.allowance}" class="form-input" placeholder=" "><label class="form-label">Allowance (15-day)</label></div>
                            <button class="btn" style="width:100%" onclick="saveAgreement('current')">Save Current</button>
                        </div>
                        <div class="card"><h2 class="card-title">New Agreement</h2>
                            <div class="form-group"><input type="number" id="newTonRate" value="${appConfig.rates.new.tonRate}" class="form-input" placeholder=" "><label class="form-label">Ton Rate</label></div>
                            <div class="form-group"><input type="number" id="newRestRate" value="${appConfig.rates.new.restRate}" class="form-input" placeholder=" "><label class="form-label">Rest Rate</label></div>
                            <div class="form-group"><input type="number" id="newLayoffRate" value="${appConfig.rates.new.layoffRate}" class="form-input" placeholder=" "><label class="form-label">Layoff Rate</label></div>
                            <div class="form-group"><input type="number" id="newAllowance" value="${appConfig.rates.new.allowance}" class="form-input" placeholder=" "><label class="form-label">Allowance (15-day)</label></div>
                            <button class="btn" style="width:100%" onclick="saveAgreement('new')">Save New</button>
                        </div></div>`;
                    container.innerHTML = content;
                    break;
                case 'bonus-page':
                    content = `<div class="card">
                        <h2 class="card-title">Annual Bonus & Gratuity Calculator</h2>
                        <p style="color: var(--md-text-secondary); font-size: 14px;">Bonus ki calculation fiscal year (10 Oct se 9 Oct) ke hisab se ki jayegi.</p>
                        <label>Fiscal Year Select Karein</label>
                        <div class="select-group"><select id="bonusYearSelect" class="form-select"></select></div>
                        <button onclick="calculateBonus()" class="btn" style="width:100%">Calculate Bonus</button>
                        <pre id="bonusResult" style="margin-top:16px; padding:12px; background: #f5f5f5; border-radius: 4px;"></pre>
                    </div>`;
                    container.innerHTML = content;
                    populateBonusYearSelector();
                    break;
                case 'arrears-page':
                    content = `<div class="card">
                        <h2 class="card-title">True Arrears Calculator</h2>
                        <p style="color: var(--md-text-secondary); font-size: 14px;">This re-calculates every single day's earning based on the difference between the 'Current' and 'New' agreements.</p>
                        <label>Select Period for Arrears Calculation</label>
                        <div class="form-group"><input type="date" id="arrearsStartDate" class="form-select"></div>
                        <div class="form-group"><input type="date" id="arrearsEndDate" class="form-select"></div>
                        <button onclick="calculateTrueArrears()" class="btn" style="width:100%">Calculate True Arrears</button>
                        <pre id="arrearsResult" style="margin-top:16px; padding:12px; background: #f5f5f5; border-radius: 4px;"></pre></div>`;
                    container.innerHTML = content;
                    break;
                case 'settings-page':
                    content = `<div class="card" style="padding:0;">
                        <div class="settings-item" onclick="showPage('generate-payroll-page', 'Generate Payroll')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                            <span>Generate Payroll</span>
                        </div>
                        <div class="settings-item" onclick="showPage('manage-workers-page', 'Manage Workers')">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            <span>Manage Workers</span>
                        </div>
                    </div>`;
                    container.innerHTML = content;
                    break;
                case 'generate-payroll-page':
                    const allowance = appConfig.rates.current.allowance;
                    content = `<div class="card">
                        <p style="font-size: 14px;">Uses <b>Current Agreement</b> rates. Allowance is <b>Rs ${allowance}</b>.</p>
                        <div class="form-group"><input type="date" id="payrollStartDate" class="form-select"></div>
                        <div class="form-group"><input type="date" id="payrollEndDate" class="form-select"></div>
                        <button onclick="generatePayroll()" class="btn" style="width:100%">Generate</button>
                        <pre id="payrollResult" style="margin-top:16px; padding: 12px; background: #f5f5f5; border-radius: 4px;"></pre>
                    </div>`;
                    container.innerHTML = content;
                    break;
                case 'manage-workers-page':
                    let workerInputsHTML = workerList.map((name, index) => {
                        return `<div class="form-group">
                                    <input type="text" id="worker-name-${index}" class="form-input" value="${name}" placeholder=" " required>
                                    <label class="form-label" for="worker-name-${index}">Worker ${index + 1} Name</label>
                                </div>`;
                    }).join('');

                    content = `<div class="card">
                        <p style="font-size: 14px; color: var(--md-text-secondary);">Yahan se aap apne workers ke naam tabdeel kar sakte hain. Khali chhorne par worker list se nikal jayega.</p>
                        ${workerInputsHTML}
                        <button onclick="saveWorkerNames()" class="btn" style="width:100%; margin-top: 16px;">Save Worker Names</button>
                      </div>`;
                    container.innerHTML = content;
                    break;
            }
        }
        
        function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); document.getElementById('overlay').classList.toggle('hidden'); }

        function _calculateSingleDay(record, agreementRates) {
            const { tonRate, restRate, layoffRate } = agreementRates;
            const { type, tonnage } = record;
            const present = Array.isArray(record.presentWorkers) ? record.presentWorkers : [];
            const presentCount = present.length > 0 ? present.length : (record.presentCount || 0);
            let dailyEarnings = {};
            workerList.forEach(w => dailyEarnings[w] = 0);
            if (presentCount === 0 && type !== 'rest') {
                workerList.forEach(w => dailyEarnings[w] = layoffRate);
                return dailyEarnings;
            }
            if (type === 'work' && presentCount > 0) {
                let perWorker = (tonnage * tonRate) / presentCount;
                if (perWorker < layoffRate) perWorker = layoffRate;
                workerList.forEach(w => { dailyEarnings[w] = present.includes(w) ? perWorker : layoffRate; });
            } else if (type === 'rest') {
                workerList.forEach(w => { dailyEarnings[w] = restRate; });
            } else if (type === 'special_overtime' && presentCount > 0) {
                let perWorker = ((tonnage * tonRate * 2) / presentCount) + layoffRate;
                workerList.forEach(w => { dailyEarnings[w] = present.includes(w) ? perWorker : layoffRate; });
            }
            return dailyEarnings;
        }

        async function calculateAndSave() {
            if (!appConfig.rates) { alert("Data not ready. Please wait."); return; }
            const date = document.getElementById('entryDate').value;
            if (!date) { alert("Please select a date."); return; }
            const dayType = document.getElementById('dayType').value;
            const tonnage = parseFloat(document.getElementById('tonnage').value) || 0;
            const presentWorkers = Array.from(document.querySelectorAll('.worker-checkbox:checked')).map(cb => cb.value);
            if (presentWorkers.length === 0 && dayType !== 'rest') { alert("Select present workers."); return; }
            
            const recordDataForCalc = { type: dayType, tonnage, presentWorkers };
            const earnings = _calculateSingleDay(recordDataForCalc, appConfig.rates.current);
            const perWorkerEarning = presentWorkers.length > 0 ? (earnings[presentWorkers[0]] || 0) : 0;
            document.getElementById('result-daily').innerText = `Calculated.\nSaved successfully!`;
            
            const recordToSave = { date, type: dayType, tonnage, presentCount: presentWorkers.length, presentWorkers, earnings, perWorkerEarning };
            await database.ref(`salaries/${auth.currentUser.uid}/${date}`).set(recordToSave);
            loadHistory();
            updateSalaryWidget();
        }

        async function updateSalaryWidget() {
            const widgetSummary = document.getElementById('widget-summary-text');
            const widgetDetails = document.getElementById('salary-widget-details');
            widgetSummary.textContent = "Calculating...";
            widgetDetails.innerHTML = "";
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const day = today.getDate();
            let startDate, endDate;
            if (day <= 15) {
                startDate = new Date(year, month, 1);
                endDate = new Date(year, month, 15);
            } else {
                startDate = new Date(year, month, 16);
                endDate = new Date(year, month + 1, 0);
            }
            const formatDate = (date) => date.toISOString().split('T')[0];
            const snapshot = await database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(formatDate(startDate)).endAt(formatDate(endDate)).once('value');
            let periodEarnings = {}; workerList.forEach(w => { periodEarnings[w] = 0; });
            if (snapshot.exists()) {
                snapshot.forEach(child => {
                    const record = child.val();
                    if(record && record.earnings) {
                        workerList.forEach(w => { periodEarnings[w] += record.earnings[w] || 0; });
                    }
                });
            }
            const allowance = appConfig.rates.current.allowance;
            const totalProjected = Object.values(periodEarnings).reduce((a, b) => a + b, 0) + (allowance * workerList.length);
            widgetSummary.textContent = `Expected Sal: Rs ${totalProjected.toFixed(0)}`;
            
            let detailsHtml = `<strong>Projected Salary</strong><hr style="border:0; border-top:1px solid var(--md-divider-color)">`;
            workerList.forEach(w => {
                detailsHtml += `<div style="display:flex; justify-content:space-between; font-size:14px;"><span>${w}</span><strong>Rs ${(periodEarnings[w] + allowance).toFixed(2)}</strong></div>`;
            });
            detailsHtml += `<hr style="border:0; border-top:1px solid var(--md-divider-color)">`;
            detailsHtml += `<div style="display:flex; justify-content:space-between; font-size:14px;"><span>Total</span><strong>Rs ${totalProjected.toFixed(2)}</strong></div>`;
            widgetDetails.innerHTML = detailsHtml;
        }
        
        function generatePayroll() {
            if (!appConfig.rates) return;
            const allowance = appConfig.rates.current.allowance;
            const startDate = document.getElementById('payrollStartDate').value;
            const endDate = document.getElementById('payrollEndDate').value;
            if(!startDate || !endDate) { alert("Please select dates."); return; }
            database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(startDate).endAt(endDate).once('value', snapshot => {
                let payroll = {}; workerList.forEach(w => { payroll[w] = 0; });
                if (!snapshot.exists()) { document.getElementById('payrollResult').innerText = "No records in this period."; return; }
                snapshot.forEach(child => {
                    const record = child.val();
                     if(record && record.earnings) {
                        workerList.forEach(w => { payroll[w] += record.earnings[w] || 0; });
                    }
                });
                let resultText = `PAYROLL: ${startDate} to ${endDate}\n-----------------------------------\n`;
                workerList.forEach(w => {
                    const finalPay = payroll[w] + allowance;
                    resultText += `${w.padEnd(10)}: Rs ${finalPay.toFixed(2)}\n`;
                });
                document.getElementById('payrollResult').innerText = resultText;
            });
        }
        
        function loadHistory() {
            const container = document.getElementById('history-table-container');
            if (!container) return;

            const selectedPeriod = document.getElementById('historyPeriodSelect').value;
            if (!selectedPeriod) {
                container.innerHTML = "<p>Please select a period to view history.</p>";
                return;
            }

            const [year, month, day] = selectedPeriod.split('-').map(Number);
            let startDate, endDate;

            if (day === 1) { 
                startDate = selectedPeriod;
                endDate = `${year}-${String(month).padStart(2, '0')}-15`;
            } else { 
                startDate = selectedPeriod;
                const lastDayOfMonth = new Date(year, month, 0).getDate();
                endDate = `${year}-${String(month).padStart(2, '0')}-${lastDayOfMonth}`;
            }
            
            container.innerHTML = "Loading history...";
            database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(startDate).endAt(endDate).once('value', snapshot => {
                if (!snapshot.exists()) {
                    container.innerHTML = "<p>No daily records found for this period.</p>";
                    return;
                }
                let rows = '';
                const records = snapshot.val();
                const sortedKeys = Object.keys(records).sort((a,b) => new Date(b) - new Date(a));
                sortedKeys.forEach(key => {
                    const rec = records[key];
                    const presentCount = rec.presentCount !== undefined ? `${rec.presentCount}/${workerList.length}` : 'N/A';
                    rows += `<tr><td>${rec.date}</td><td>${rec.type}</td><td>${presentCount}</td><td>${(rec.perWorkerEarning || 0).toFixed(2)}</td></tr>`;
                });
                container.innerHTML = `<table style="width:100%; border-collapse:collapse;"><thead><tr><th>Date</th><th>Type</th><th>Present</th><th>Earning</th></tr></thead><tbody>${rows}</tbody></table>`;
            });
        }

        async function calculateTrueArrears() {
            const resultElem = document.getElementById('arrearsResult');
            resultElem.innerText = 'Calculating... Fetching records...';
            const start = document.getElementById('arrearsStartDate').value;
            const end = document.getElementById('arrearsEndDate').value;
            if(!start || !end) { resultElem.innerText = 'Please select dates.'; return; }
            const snapshot = await database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(start).endAt(end).once('value');
            if (!snapshot.exists()) { resultElem.innerText = 'No records in period.'; return; }

            let actualTotals = {}; workerList.forEach(w => actualTotals[w] = 0);
            let hypotheticalTotals = {}; workerList.forEach(w => hypotheticalTotals[w] = 0);
            
            const records = snapshot.val();
            for (const date in records) {
                const record = records[date];
                if (record && record.earnings) {
                    const oldEarnings = record.earnings;
                    const newEarnings = _calculateSingleDay(record, appConfig.rates.new);
                    workerList.forEach(w => {
                        actualTotals[w] += oldEarnings[w] || 0;
                        hypotheticalTotals[w] += newEarnings[w] || 0;
                    });
                }
            }

            const diffDays = Math.ceil(Math.abs(new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) + 1;
            const numPeriods = Math.floor(diffDays / 15);
            const allowanceArrears = numPeriods * (appConfig.rates.new.allowance - appConfig.rates.current.allowance);
            
            let resultText = `TRUE ARREARS: ${start} to ${end}\n-----------------------------------\n\n`;
            workerList.forEach(w => {
                const dailyArrears = hypotheticalTotals[w] - actualTotals[w];
                const totalArrears = dailyArrears + allowanceArrears;
                resultText += `${w.padEnd(10)}:\n`;
                resultText += `  Daily Pay Arrears: Rs ${dailyArrears.toFixed(2)}\n`;
                resultText += `  Allowance Arrears: Rs ${allowanceArrears.toFixed(2)}\n`;
                resultText += `  >> TOTAL ARREARS: Rs ${totalArrears.toFixed(2)} <<\n\n`;
            });
            resultElem.innerText = resultText;
        }

        function initializeHistoryView() {
            populateHistorySelector(); 
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const selector = document.getElementById('historyPeriodSelect');
            if (selector){
                 if (day <= 15) {
                    selector.value = `${year}-${String(month).padStart(2, '0')}-01`;
                } else {
                    selector.value = `${year}-${String(month).padStart(2, '0')}-16`;
                }
                selector.addEventListener('change', loadHistory); 
                loadHistory(); 
            }
        }

        function populateHistorySelector() {
            const select = document.getElementById('historyPeriodSelect');
            if (!select) return;
            select.innerHTML = '';
            
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let currentDate = new Date();
            for (let i = 0; i < 12; i++) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = monthNames[month];

                let option2 = document.createElement('option');
                option2.value = `${year}-${String(month + 1).padStart(2, '0')}-16`; 
                option2.textContent = `${monthName} ${year} - (16 se Aakhir Tak)`;
                select.appendChild(option2);
                
                let option1 = document.createElement('option');
                option1.value = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                option1.textContent = `${monthName} ${year} - (1 se 15 Tak)`;
                select.appendChild(option1);

                currentDate.setMonth(currentDate.getMonth() - 1);
            }
        }
        
        function populateBonusYearSelector() {
            const select = document.getElementById('bonusYearSelect');
            if (!select) return;
            select.innerHTML = '';
            let currentYear = new Date().getFullYear();
            
            const today = new Date();
            if (today.getMonth() < 9 || (today.getMonth() === 9 && today.getDate() < 10)) {
                currentYear--;
            }
            
            for (let i = 0; i < 5; i++) {
                const year = currentYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `Oct ${year} - Oct ${year + 1}`;
                select.appendChild(option);
            }
        }

        async function calculateBonus() {
            const resultElem = document.getElementById('bonusResult');
            const bonusYearSelect = document.getElementById('bonusYearSelect');
            if (!bonusYearSelect.value) {
                resultElem.innerText = 'Please select a fiscal year.';
                return;
            }

            resultElem.innerText = 'Calculating... Fetching yearly records...';
            
            const startYear = parseInt(bonusYearSelect.value);
            const startDate = `${startYear}-10-10`;
            const endDate = `${startYear + 1}-10-09`;

            const snapshot = await database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(startDate).endAt(endDate).once('value');
            if (!snapshot.exists()) {
                resultElem.innerText = `No records found for the fiscal year ${startYear}-${startYear + 1}.`;
                return;
            }
            
            let yearlyEarnings = {};
            workerList.forEach(w => { yearlyEarnings[w] = 0; });
            
            snapshot.forEach(child => {
                const record = child.val();
                if(record && record.earnings) {
                    workerList.forEach(w => {
                        yearlyEarnings[w] += record.earnings[w] || 0;
                    });
                }
            });

            const numberOfAllowances = 24; 
            const singleAllowance = appConfig.rates.current.allowance || 0;
            const totalAllowancePerWorker = singleAllowance * numberOfAllowances;

            let resultText = `BONUS & GRATUITY\nFiscal Year: ${startDate} to ${endDate}\n`;
            resultText += `--------------------------------------\n\n`;

            workerList.forEach(w => {
                const totalYearlyPay = yearlyEarnings[w] + totalAllowancePerWorker;
                const averageMonthlySalary = totalYearlyPay / 12;
                const gratuity = averageMonthlySalary;
                const totalBonus = averageMonthlySalary + gratuity;

                resultText += `${w.padEnd(10)}:\n`;
                resultText += `  Yearly Pay (inc. allowance): Rs ${totalYearlyPay.toFixed(2)}\n`;
                resultText += `  Avg Monthly Salary:          Rs ${averageMonthlySalary.toFixed(2)}\n`;
                resultText += `  Gratuity Amount:             Rs ${gratuity.toFixed(2)}\n`;
                resultText += `  >> TOTAL BONUS PAYABLE:      Rs ${totalBonus.toFixed(2)} <<\n\n`;
            });
            
            resultElem.innerText = resultText;
        }

    </script>
</body>
</html>