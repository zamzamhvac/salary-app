<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Pro</title>
    <!-- Material Icons (for menu, etc.) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* CSS (Styling) Section */
        :root {
            --primary-color: #00796B; /* Teal */
            --accent-color: #00BCD4;  /* Cyan */
            --dark-primary-color: #004D40;
            --light-primary-color: #B2DFDB;
            --text-color: #212121;
            --primary-text-color: #FFFFFF;
            --secondary-text-color: #757575;
            --divider-color: #BDBDBD;
            --background-color: #f5f5f5;
        }

        /* General Body and Reset Styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        
        /* App Layout Containers */
        #auth-container, .page { display: none; }
        #auth-container.active, .page.active { display: block; }
        #app-container { display: none; }
        main { padding: 80px 16px 80px 16px; }

        /* Material Design Inspired Components */
        .card { background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 2px 10px rgba(0,0,0,0.08); padding: 16px; margin-bottom: 16px; }
        .btn { background-color: var(--primary-color); color: var(--primary-text-color); border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; text-transform: uppercase; box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 3px 1px -2px rgba(0,0,0,0.12), 0 1px 5px 0 rgba(0,0,0,0.2); transition: background-color 0.3s, box-shadow 0.3s; width: 100%; margin-top: 10px; }
        .btn-accent { background-color: var(--accent-color); }
        .btn:hover { background-color: var(--dark-primary-color); box-shadow: 0 4px 5px 0 rgba(0,0,0,0.14), 0 1px 10px 0 rgba(0,0,0,0.12), 0 2px 4px -1px rgba(0,0,0,0.3); }
        .btn-link { background: none; box-shadow: none; color: var(--primary-color); padding: 0; margin: 10px 0; text-transform: none; cursor: pointer; width: auto; }
        .input-group { position: relative; margin: 25px 0; }
        .input-group input, .input-group select { width: 100%; padding: 12px 10px; border: none; border-bottom: 1px solid var(--divider-color); background-color: transparent; font-size: 16px; outline: none; }
        .input-group label { position: absolute; top: 12px; left: 10px; color: var(--secondary-text-color); pointer-events: none; transition: all 0.2s ease; }
        .input-group input:focus + label, .input-group input:not(:placeholder-shown) + label, .input-group select:valid + label { top: -10px; left: 5px; font-size: 12px; color: var(--primary-color); }
        .input-group input:focus, .input-group select:focus { border-bottom: 2px solid var(--primary-color); }
        
        /* Layout: App Bar, Navs */
        .app-bar { position: fixed; top: 0; left: 0; right: 0; height: 60px; background-color: var(--primary-color); color: var(--primary-text-color); display: flex; align-items: center; padding: 0 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1000; }
        .app-bar .menu-btn { background: none; border: none; color: white; cursor: pointer; }
        .app-bar-title { margin-left: 24px; font-size: 20px; font-weight: 500; }
        .side-nav { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background-color: white; box-shadow: 2px 0 5px rgba(0,0,0,0.2); transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 2000; }
        .side-nav.open { transform: translateX(0); }
        .side-nav-header { padding: 20px; background-color: var(--accent-color); color: white; }
        .side-nav ul { list-style: none; }
        .side-nav ul li a { display: block; padding: 15px 20px; color: var(--text-color); text-decoration: none; transition: background-color 0.2s; }
        .side-nav ul li a:hover, .side-nav ul li a.active { background-color: var(--light-primary-color); }
        .nav-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease-in-out; }
        .nav-overlay.open { opacity: 1; visibility: visible; }
        .bottom-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background-color: white; box-shadow: 0 -2px 4px rgba(0,0,0,0.1); z-index: 1000; justify-content: space-around; align-items: center; }
        .bottom-nav-item { background: none; border: none; color: var(--secondary-text-color); display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px; flex-grow: 1; }
        .bottom-nav-item.active { color: var(--primary-color); }
        .bottom-nav-item .icon { font-size: 24px; }
        .bottom-nav-item .label { font-size: 12px; }
        @media (min-width: 769px) { .bottom-nav { display: none; } }
        
        /* Components: Loader, Modal, Snackbar */
        .hidden { display: none !important; }
        #snackbar { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 3000; left: 50%; transform: translateX(-50%); bottom: 30px; transition: visibility 0s, opacity 0.5s linear; }
        #snackbar.show { visibility: visible; opacity: 1; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 9998; display: flex; justify-content: center; align-items: center; }
        .spinner { border: 8px solid var(--divider-color); border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; }
        .modal-buttons { display: flex; justify-content: flex-end; margin-top: 20px; }
        .modal-buttons button { margin-left: 10px; width: auto; }
        
        /* Page-specific styles */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px; border-bottom: 1px solid var(--divider-color); text-align: left; }
        .data-table th { background-color: #f0f0f0; }
        #daily-entry-work-fields { display: none; }
        .attendance-list label { display: block; margin-bottom: 10px; }
        pre { background-color: #eee; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; }
    </style>
</head>
<body>

    <!-- Global Loader, Snackbar, and Modal -->
    <div id="loader" class="hidden"><div class="spinner"></div></div>
    <div id="snackbar"></div>
    <div id="confirmation-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title">Confirmation</h3><p id="modal-message">Are you sure?</p>
            <div class="modal-buttons"><button id="modal-cancel-btn" class="btn-link">Cancel</button><button id="modal-confirm-btn" class="btn">Confirm</button></div>
        </div>
    </div>

    <!-- Authentication Container -->
    <div id="auth-container" class="active">
        <main>
            <div id="login-form" class="card">
                <h2>Login to Salary Pro</h2>
                <div class="input-group"><input type="email" id="login-email" required placeholder=" "><label for="login-email">Email</label></div>
                <div class="input-group"><input type="password" id="login-password" required placeholder=" "><label for="login-password">Password</label></div>
                <p id="login-error" style="color:red;"></p>
                <button id="login-btn" class="btn">Login</button>
                <button id="show-signup-btn" class="btn-link">Don't have an account? Sign Up</button>
                <button id="forgot-password-btn" class="btn-link">Forgot Password?</button>
            </div>
            <div id="signup-form" class="card hidden">
                <h2>Create Account</h2>
                <div class="input-group"><input type="email" id="signup-email" required placeholder=" "><label for="signup-email">Email</label></div>
                <div class="input-group"><input type="password" id="signup-password" required placeholder=" "><label for="signup-password">Password</label></div>
                <p id="signup-error" style="color:red;"></p>
                <button id="signup-btn" class="btn">Sign Up</button>
                <button id="show-login-btn" class="btn-link">Already have an account? Login</button>
            </div>
        </main>
    </div>

    <!-- Main Application Container -->
    <div id="app-container">
        <header class="app-bar">
            <button class="menu-btn" id="menu-btn"><i class="material-icons">menu</i></button>
            <h1 id="app-bar-title" class="app-bar-title"></h1>
            <div style="flex-grow: 1;"></div>
            <button id="logout-btn" class="btn-link" style="color: white;">Logout</button>
        </header>
        <div class="nav-overlay" id="nav-overlay"></div>
        <nav class="side-nav" id="side-nav">
            <div class="side-nav-header"><h3>Salary Pro</h3><p id="user-email-nav" style="font-size: 14px;"></p></div>
            <ul>
                <li><a href="#daily-entry" class="nav-link active">Daily Entry</a></li>
                <li><a href="#salaries" class="nav-link">Salaries</a></li>
                <li><a href="#bonus" class="nav-link">Bonus</a></li>
                <li><a href="#arrears" class="nav-link">Arrears</a></li>
                <li><a href="#leaves" class="nav-link">Leaves</a></li>
                <li><a href="#settings" class="nav-link">Settings</a></li>
            </ul>
        </nav>
        <main>
            <!-- Daily Entry Page -->
            <div id="daily-entry" class="page">
                <div class="card">
                    <h3>Daily Work Entry</h3>
                    <div class="input-group"><input type="date" id="daily-entry-date" required placeholder=" "><label for="daily-entry-date">Entry Date</label></div>
                    <div class="input-group">
                        <select id="daily-entry-day-type" required><option value="" disabled selected>Select Day Type</option><option value="Work Day">Work Day</option><option value="Rest Day">Rest Day</option><option value="Special Overtime">Special Overtime</option></select>
                        <label for="daily-entry-day-type">Day Type</label>
                    </div>
                    <div id="daily-entry-work-fields">
                        <div class="input-group"><input type="number" id="daily-entry-tonnage" placeholder=" "><label for="daily-entry-tonnage">Total Tonnage</label></div>
                        <div class="input-group"><input type="number" id="daily-entry-wagons" placeholder=" "><label for="daily-entry-wagons">Number of Wagons</label></div>
                    </div>
                    <div id="daily-entry-attendance"><h4>Worker Attendance</h4><div id="daily-entry-attendance-list" class="attendance-list"></div></div>
                    <button id="calculate-save-btn" class="btn">Calculate & Save</button>
                </div>
            </div>

            <!-- Salaries Page -->
            <div id="salaries" class="page">
                <div class="card"><h3>Expected Salary (Current Period)</h3><div id="expected-salary-list"></div></div>
                <div class="card">
                    <h3>Historical Salaries</h3>
                    <div class="input-group"><select id="salary-period-select"></select><label for="salary-period-select">Select Period</label></div>
                    <table class="data-table"><thead><tr><th>Date</th><th>Tons</th><th>Wagons</th><th>Earning</th></tr></thead><tbody id="salaries-table-body"></tbody></table>
                    <div id="salary-summary-list" style="margin-top: 20px;"></div>
                </div>
            </div>
            
            <!-- Bonus Page -->
            <div id="bonus" class="page">
                <div class="card">
                    <h3>Calculate Annual Bonus</h3>
                    <div class="input-group"><select id="bonus-fiscal-year-select"></select><label>Select Fiscal Year</label></div>
                    <button id="calculate-bonus-btn" class="btn">Calculate Bonus</button>
                    <div id="bonus-results-container" style="margin-top: 20px;"><h4>Bonus Calculation Result:</h4><pre id="bonus-results-pre"></pre></div>
                </div>
            </div>

            <!-- Other Pages (Stubs) -->
            <div id="arrears" class="page"><div class="card"><h3>Arrears</h3><p>This feature is under development.</p></div></div>
            <div id="leaves" class="page"><div class="card"><h3>Leaves</h3><p>This feature is under development.</p></div></div>
            <div id="settings" class="page"><div class="card"><h3>Settings</h3><p>This feature is under development.</p></div></div>
        </main>
        
        <!-- Bottom Navigation Bar -->
        <div class="bottom-nav" id="bottom-nav">
            <button class="bottom-nav-item active" data-page="daily-entry"><i class="material-icons icon">edit_calendar</i><span class="label">Daily Entry</span></button>
            <button class="bottom-nav-item" data-page="salaries"><i class="material-icons icon">payments</i><span class="label">Salaries</span></button>
            <button class="bottom-nav-item" data-page="bonus"><i class="material-icons icon">card_giftcard</i><span class="label">Bonus</span></button>
        </div>
    </div>

    <script>
    // =================================================================================
    // JAVASCRIPT SECTION
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {

        // --- Firebase Configuration ---
        // =======================================================================
        // ==  AHEM! AAP APNI FIREBASE CONSOLE SE KEYS COPY KARKE YAHAN PASTE KAREIN  ==
        // =======================================================================
        const firebaseConfig = {
            apiKey: "PASTE_YOUR_API_KEY_HERE",
            authDomain: "PASTE_YOUR_AUTH_DOMAIN_HERE",
            databaseURL: "PASTE_YOUR_DATABASE_URL_HERE",
            projectId: "PASTE_YOUR_PROJECT_ID_HERE",
            storageBucket: "PASTE_YOUR_STORAGE_BUCKET_HERE",
            messagingSenderId: "PASTE_YOUR_MESSAGING_SENDER_ID_HERE",
            appId: "PASTE_YOUR_APP_ID_HERE"
        };
        
        // --- Global State ---
        let firebaseApp, auth, database, currentUser = null;
        let userConfig = {}, userWorkers = [], userAgreements = {};
        let currentModalCallback = null;

        // --- UI Element References ---
        const loader = document.getElementById('loader');
        const snackbar = document.getElementById('snackbar');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const appBarTitle = document.getElementById('app-bar-title');
        const sideNav = document.getElementById('side-nav');
        const navOverlay = document.getElementById('nav-overlay');
        const userEmailNav = document.getElementById('user-email-nav');

        // --- Utility & Component Functions ---
        const showLoader = () => loader.classList.remove('hidden');
        const hideLoader = () => loader.classList.add('hidden');
        const showSnackbar = (message) => {
            snackbar.textContent = message;
            snackbar.className = "show";
            setTimeout(() => { snackbar.className = snackbar.className.replace("show", ""); }, 3000);
        };
        const showConfirmationModal = (title, message, callback) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('confirmation-modal').classList.remove('hidden');
            currentModalCallback = callback;
        };
        const hideConfirmationModal = () => {
            document.getElementById('confirmation-modal').classList.add('hidden');
            currentModalCallback = null;
        };
        document.getElementById('modal-confirm-btn').addEventListener('click', () => {
            if (currentModalCallback) currentModalCallback();
            hideConfirmationModal();
        });
        document.getElementById('modal-cancel-btn').addEventListener('click', hideConfirmationModal);

        // --- Firebase Initialization ---
        function initializeFirebase() {
            if (firebaseConfig.apiKey.startsWith("PASTE_YOUR")) {
                document.getElementById('login-error').textContent = "Firebase is not configured. Please add your API keys in the script.";
                alert("ATTENTION: Firebase keys are not set! Please add your keys in the script section of the HTML file.");
                return;
            }
            try {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                database = firebase.database();
                auth.onAuthStateChanged(handleAuthStateChange);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showSnackbar("Error: Could not start the application.");
            }
        }

        // --- Authentication ---
        function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                authContainer.classList.remove('active');
                appContainer.style.display = 'block';
                userEmailNav.textContent = currentUser.email;
                loadInitialData();
            } else {
                currentUser = null;
                authContainer.classList.add('active');
                appContainer.style.display = 'none';
            }
        }
        
        // --- Data Loading ---
        async function loadInitialData() {
            if (!currentUser) return;
            showLoader();
            try {
                const uid = currentUser.uid;
                const [configSnap, workersSnap, agreementsSnap] = await Promise.all([
                    database.ref(`configs/${uid}`).once('value'),
                    database.ref(`workers/${uid}`).once('value'),
                    database.ref(`agreements/${uid}`).once('value')
                ]);
                userConfig = configSnap.val() || {};
                userWorkers = workersSnap.val() || ["Worker1", "Worker2"]; // Default workers
                userAgreements = agreementsSnap.val() || { current: {}, new: {} }; // Default agreements
                
                navigateTo('daily-entry');
            } catch (error) {
                console.error("Error loading initial data:", error);
                showSnackbar("Failed to load user data.");
            } finally {
                hideLoader();
            }
        }
        
        // --- Auth Event Listeners ---
        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            if (!auth) {
                 errorP.textContent = "Firebase is not initialized. Check API keys.";
                 return;
            }
            showLoader();
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => { errorP.textContent = error.message; })
                .finally(hideLoader);
        });
        document.getElementById('signup-btn').addEventListener('click', () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            // Add signup logic
        });
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

        // --- Navigation ---
        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');

            const linkEl = document.querySelector(`.nav-link[href="#${pageId}"]`);
            appBarTitle.textContent = linkEl ? linkEl.textContent : 'Salary Pro';

            document.querySelectorAll('.nav-link, .bottom-nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${pageId}` || link.dataset.page === pageId) {
                    link.classList.add('active');
                }
            });
            
            sideNav.classList.remove('open');
            navOverlay.classList.remove('open');

            // Page-specific setup calls
            if (pageId === 'bonus' || pageId === 'leaves') {
                populateFiscalYearDropdowns();
            }
             if (pageId === 'daily-entry') {
                populateWorkersList();
            }
        }
        document.getElementById('menu-btn').addEventListener('click', () => { sideNav.classList.add('open'); navOverlay.classList.add('open'); });
        navOverlay.addEventListener('click', () => { sideNav.classList.remove('open'); navOverlay.classList.remove('open'); });
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => { e.preventDefault(); navigateTo(e.currentTarget.getAttribute('href').substring(1)); });
        });
        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.addEventListener('click', (e) => navigateTo(e.currentTarget.dataset.page));
        });

        // --- Core Calculation Logic ---
        function _calculateSingleDay(record, agreementType = 'current') {
            const agreementRates = userAgreements[agreementType] || {};
            const { tonRate = 0, restRate = 0, layoffRate = 0, perWagonRate = 0 } = agreementRates;
            const { dayType, tonnage = 0, wagons = 0, attendance = [] } = record;
            const presentCount = attendance.length;
            
            let dailyEarnings = {};
            userWorkers.forEach(w => dailyEarnings[w] = 0);

            if (dayType === 'Rest Day') {
                userWorkers.forEach(w => { dailyEarnings[w] = restRate; });
                return dailyEarnings;
            }

            if (presentCount === 0) {
                userWorkers.forEach(w => dailyEarnings[w] = layoffRate);
                return dailyEarnings;
            }

            const tonnagePay = (tonnage * tonRate) / presentCount;
            const wagonPay = (wagons * perWagonRate) / presentCount;
            const basePay = Math.max(tonnagePay, layoffRate);
            
            let perWorkerPay;
            if (dayType === 'Special Overtime') {
                perWorkerPay = (basePay * 2) + layoffRate + wagonPay;
            } else { // Work Day
                perWorkerPay = basePay + wagonPay;
            }

            userWorkers.forEach(w => {
                dailyEarnings[w] = attendance.includes(w) ? perWorkerPay : layoffRate;
            });
            
            for(const worker in dailyEarnings){
                dailyEarnings[worker] = parseFloat(dailyEarnings[worker].toFixed(2));
            }
            return dailyEarnings;
        }

        // --- Page: Daily Entry ---
        function populateWorkersList() {
            const listDiv = document.getElementById('daily-entry-attendance-list');
            listDiv.innerHTML = '';
            if (userWorkers.length === 0) {
                listDiv.innerHTML = '<p>No workers configured.</p>';
                return;
            }
            userWorkers.forEach(worker => {
                listDiv.innerHTML += `<label><input type="checkbox" class="attendance-checkbox" value="${worker}" checked> ${worker}</label>`;
            });
        }
        document.getElementById('daily-entry-day-type').addEventListener('change', (e) => {
            const workFields = document.getElementById('daily-entry-work-fields');
            const show = (e.target.value === 'Work Day' || e.target.value === 'Special Overtime');
            workFields.style.display = show ? 'block' : 'none';
        });
        document.getElementById('calculate-save-btn').addEventListener('click', () => {
            showConfirmationModal('Save Entry', 'Are you sure you want to save this daily entry?', saveDailyEntry);
        });
        function saveDailyEntry() { /* Logic for saving daily entry */ }

        // --- Page: Bonus ---
        async function _calculateBonusForPeriod(startDate, endDate) {
            const snapshot = await database.ref(`salaries/${currentUser.uid}`).orderByKey().startAt(startDate).endAt(endDate).once('value');
            
            let results = {};
            userWorkers.forEach(w => {
                results[w] = { totalPayableBonus: 0, averageMonthlySalary: 0, gratuity: 0, paidLeavesBonus: 0, paidLeavesRemaining: 0 };
            });

            if (!snapshot.exists()) return results;
            const periodData = snapshot.val();

            let yearlyEarnings = {}; userWorkers.forEach(w => yearlyEarnings[w] = 0);
            let leaveCounts = {}; userWorkers.forEach(w => leaveCounts[w] = 0);

            for (const date in periodData) {
                const record = periodData[date];
                if (record) {
                    const dayEarnings = _calculateSingleDay(record, 'current');
                    userWorkers.forEach(w => { yearlyEarnings[w] += dayEarnings[w] || 0; });
                    
                    if (record.dayType === 'Work Day' || record.dayType === 'Special Overtime') {
                        const present = record.attendance || [];
                        userWorkers.forEach(w => { if (!present.includes(w)) leaveCounts[w]++; });
                    }
                }
            }

            const agreementRates = userAgreements.current || {};
            const monthlyAllowance = agreementRates.allowance || 0;
            const totalAllowancePerWorker = monthlyAllowance * 12;
            const layoffRate = agreementRates.layoffRate || 0;

            if (layoffRate === 0) {
                showSnackbar("Warning: Layoff Rate is not set in Current Agreement. Cannot calculate leave bonus.");
            }

            userWorkers.forEach(w => {
                const totalYearlyPay = yearlyEarnings[w] + totalAllowancePerWorker;
                const averageMonthlySalary = totalYearlyPay / 12;
                const gratuity = averageMonthlySalary;
                const totalLeavesTaken = leaveCounts[w] || 0;
                const paidLeavesTaken = Math.max(0, totalLeavesTaken - 20);
                const paidLeavesRemaining = Math.max(0, 12 - paidLeavesTaken);
                const paidLeavesBonus = layoffRate > 0 ? (paidLeavesRemaining * layoffRate) : 0;
                const totalPayableBonus = averageMonthlySalary + gratuity + paidLeavesBonus;
                results[w] = { totalPayableBonus, averageMonthlySalary, gratuity, paidLeavesBonus, paidLeavesRemaining };
            });
            return results;
        }

        document.getElementById('calculate-bonus-btn').addEventListener('click', async () => {
            const resultPre = document.getElementById('bonus-results-pre');
            const bonusYearSelect = document.getElementById('bonus-fiscal-year-select');
            
            if (!bonusYearSelect.value) {
                resultPre.textContent = 'Please select a fiscal year.'; return;
            }
            
            showLoader();
            resultPre.textContent = 'Calculating... Please wait.';

            try {
                const startYear = parseInt(bonusYearSelect.value);
                const startDate = `${startYear}-10-10`;
                const endDate = `${startYear + 1}-10-09`;
                
                const bonusData = await _calculateBonusForPeriod(startDate, endDate);

                let resultText = `BONUS & GRATUITY REPORT\n`;
                resultText += `Fiscal Year: ${startDate} to ${endDate}\n`;
                resultText += `(Based on Current Agreement Rates)\n`;
                resultText += `--------------------------------------\n\n`;
                
                userWorkers.forEach(w => {
                    const data = bonusData[w];
                    if (!data) return;
                    
                    resultText += `${w.padEnd(10)}:\n`;
                    resultText += `  Avg Monthly Salary (Bonus):  Rs ${data.averageMonthlySalary.toFixed(2)}\n`;
                    resultText += `  Gratuity Amount:             Rs ${data.gratuity.toFixed(2)}\n`;
                    resultText += `  Paid Leaves Bonus (${data.paidLeavesRemaining.toFixed(0)} days): Rs ${data.paidLeavesBonus.toFixed(2)}\n`;
                    resultText += `  ------------------------------------\n`;
                    resultText += `  >> TOTAL PAYABLE BONUS:      Rs ${data.totalPayableBonus.toFixed(2)} <<\n\n`;
                });
                resultPre.textContent = resultText;
            } catch (error) {
                console.error("Bonus Calculation Error:", error);
                resultPre.textContent = `An error occurred during calculation: ${error.message}`;
            } finally {
                hideLoader();
            }
        });

        function populateFiscalYearDropdowns() {
            const selects = document.querySelectorAll('#bonus-fiscal-year-select, #leaves-fiscal-year-select');
            selects.forEach(select => {
                if(!select) return;
                select.innerHTML = '<option value="" disabled selected>Select a fiscal year</option>';
                let currentYear = new Date().getFullYear();
                if (new Date().getMonth() < 9 || (new Date().getMonth() === 9 && new Date().getDate() < 10)) {
                    currentYear--;
                }
                for (let i = 0; i < 5; i++) {
                    const year = currentYear - i;
                    select.add(new Option(`Oct ${year} - Oct ${year + 1}`, `${year}`));
                }
            });
        }
        
        // --- Initialize the Application ---
        initializeFirebase();
    });
    </script>
</body>
</html>
