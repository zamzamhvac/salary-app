<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
    :root {
        --md-primary-color: #00796B; /* Teal */
        --md-accent-color: #00BCD4;  /* Cyan */
        --md-background-color: #F5F5F5;
        --md-surface-color: #FFFFFF; 
        --md-text-primary: #212121; 
        --md-text-secondary: #757575;
        --md-divider-color: #E0E0E0; 
        --md-shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        --md-shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        --color-success: #4CAF50; 
        --color-error: #D32F2F;
    }
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--md-background-color); color: var(--md-text-primary); margin: 0; line-height: 1.5; -webkit-font-smoothing: antialiased; }
    .hidden { display: none !important; }
    .page { display: none; animation: fadeIn 0.4s ease-in-out; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: var(--md-surface-color); padding: 24px; border-radius: 8px; box-shadow: var(--md-shadow-1); margin-bottom: 16px; border-top: 4px solid var(--md-accent-color); transition: box-shadow 0.3s ease; }
    .card:hover { box-shadow: var(--md-shadow-2); }
    .card-title { font-size: 20px; font-weight: 500; margin: 0 0 24px 0; color: var(--md-primary-color); }
    #login-container { display: flex; justify-content: center; align-items: center; height: 100vh; padding: 16px; }
    .login-card { border-top: 4px solid var(--md-primary-color); padding: 24px 32px; border-radius: 8px; box-shadow: var(--md-shadow-2); width: 100%; max-width: 400px; text-align: center; }
    .login-card h1 { color: var(--md-primary-color); margin-bottom: 24px; font-weight: 500; }
    #auth-error { color: var(--color-error); margin-top: 16px; font-size: 14px; min-height: 20px; }
    .form-group { position: relative; margin-bottom: 24px; }
    .form-input { width: 100%; padding: 12px 0 8px 0; border: none; border-bottom: 1px solid var(--md-text-secondary); background: transparent; font-size: 16px; }
    .form-input:focus { outline: none; border-bottom: 2px solid var(--md-primary-color); }
    .form-label { position: absolute; top: 12px; left: 0; font-size: 16px; color: var(--md-text-secondary); pointer-events: none; transition: 0.2s ease all; }
    .form-input:focus ~ .form-label, .form-input:not(:placeholder-shown) ~ .form-label { top: -10px; font-size: 12px; color: var(--md-primary-color); }
    .form-select { width: 100%; padding: 12px; margin-bottom: 16px; border: 1px solid var(--md-divider-color); border-radius: 4px; background-color: transparent; font-size: 16px; appearance: none; }
    .select-group { position: relative; }
    .select-group::after { content: 'â–¼'; position: absolute; top: 12px; right: 12px; color: var(--md-text-secondary); pointer-events: none; }
    .btn { color: white; padding: 10px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; text-transform: uppercase; box-shadow: var(--md-shadow-1); transition: box-shadow 0.2s, background-color 0.2s; }
    .btn:hover { box-shadow: var(--md-shadow-2); }
    .btn.primary { background-color: var(--md-primary-color); }
    .btn.secondary { background-color: #757575; }
    .btn.accent { background-color: var(--md-accent-color); color: white; }
    .settings-item { display: flex; align-items: center; padding: 16px; border-bottom: 1px solid var(--md-divider-color); cursor: pointer; }
    .settings-item:hover { background-color: var(--md-background-color); }
    .settings-item svg { margin-right: 24px; color: var(--md-text-secondary); }
    .settings-item span { font-weight: 500; font-size: 16px; }
    #app-container { display: flex; flex-direction: column; min-height: 100vh; }
    .top-app-bar { display: flex; align-items: center; padding: 0 8px; height: 56px; background-color: var(--md-primary-color); color: white; box-shadow: var(--md-shadow-2); position: sticky; top: 0; z-index: 1000; }
    .icon-btn { background: none; border: none; color: white; padding: 12px; border-radius: 50%; cursor: pointer; }
    .app-bar-title { font-size: 20px; font-weight: 500; margin-left: 16px; }
    .nav-drawer { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--md-surface-color); box-shadow: var(--md-shadow-2); z-index: 2000; transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
    .nav-drawer.open { transform: translateX(0); }
    .nav-header { padding: 16px; border-bottom: 1px solid var(--md-divider-color); }
    .nav-header h2 { color: var(--md-primary-color); margin: 0; font-weight: 500; }
    .nav-list { list-style: none; padding: 8px 0; margin: 0; flex-grow: 1; }
    .nav-list a { display: flex; align-items: center; padding: 12px 16px; color: var(--md-text-primary); text-decoration: none; font-weight: 500; border-left: 4px solid transparent; }
    .nav-list a:hover { background-color: rgba(0,0,0,0.04); }
    .nav-list a.active { color: var(--md-accent-color); border-left-color: var(--md-accent-color); background-color: rgba(0, 188, 212, 0.1); }
    .nav-list a.active svg { color: var(--md-accent-color); }
    .nav-list a svg { margin-right: 24px; color: var(--md-text-secondary); transition: color 0.2s; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999; }
    main { padding: 16px; padding-bottom: 72px; flex-grow: 1; }
    .page-content { max-width: 1200px; margin: 0 auto; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 56px; background: var(--md-surface-color); box-shadow: 0 -1px 3px rgba(0,0,0,0.1); display: flex; z-index: 500; }
    .bottom-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--md-text-secondary); border: none; background: none; cursor: pointer; padding: 4px 0; border-top: 3px solid transparent; transition: color 0.2s; }
    .bottom-nav-item.active { color: var(--md-accent-color); border-top-color: var(--md-accent-color); }
    .bottom-nav-item span { font-size: 12px; margin-top: 2px; }
    @media (min-width: 768px) { .bottom-nav { display: none; } }
    pre { white-space: pre-wrap; font-family: monospace; }
    #snackbar { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; font-size: 16px; box-shadow: var(--md-shadow-2); }
    #snackbar.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    #snackbar.success { background-color: var(--color-success); }
    #snackbar.error { background-color: var(--color-error); }
    @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    #confirmation-modal { position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; }
    .modal-content { background-color: var(--md-surface-color); padding: 24px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: var(--md-shadow-2); }
    .modal-content p { margin: 0 0 24px 0; font-size: 16px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; }
    .loader { width: 48px; height: 48px; border: 5px solid var(--md-background-color); border-bottom-color: var(--md-primary-color); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; margin: 24px auto; }
    @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader-container { display: flex; justify-content: center; align-items: center; min-height: 150px; }
    .grid-layout { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 960px) { .grid-layout { grid-template-columns: 1fr 1fr; } }
    .stagger-in > * { opacity: 0; transform: translateY(15px); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
    
    /* New styles for cycle indicator */
    .cycle-indicator { 
        background-color: #e3f2fd; 
        padding: 8px 12px; 
        border-radius: 20px; 
        font-size: 14px; 
        margin-bottom: 16px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .cycle-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--md-primary-color);
        color: white;
        border-radius: 50%;
        font-weight: bold;
    }
    .cycle-work { background-color: #e3f2fd; }
    .cycle-rest { background-color: #e8f5e9; }
</style>
</head>
<body>
    <div id="snackbar"></div>
    <div id="confirmation-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-text"></p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn secondary">Cancel</button>
                <button id="modal-confirm-btn" class="btn primary">Confirm</button>
            </div>
        </div>
    </div>
    <div id="login-container">
        <div class="login-card">
            <h1>Salary Pro</h1>
            <div class="form-group"><input type="email" id="email" class="form-input" placeholder=" " required><label for="email" class="form-label">Email</label></div>
            <div class="form-group"><input type="password" id="password" class="form-input" placeholder=" " required><label for="password" class="form-label">Password</label></div>
            <button id="login-btn" class="btn primary" style="width:100%;">Login</button>
            <p style="margin: 16px 0; color: var(--md-text-secondary);">OR</p>
            <button id="signup-btn" class="btn secondary" style="width:100%;">Sign Up</button>
            <p id="auth-error"></p>
        </div>
    </div>
    <div id="app-container" class="hidden">
        <div id="overlay" class="hidden" onclick="toggleMenu()"></div>
        <div id="side-menu" class="nav-drawer">
            <div class="nav-header"><h2>Salary Pro</h2></div>
            <ul class="nav-list">
                <li><a href="#" class="nav-link" data-page="daily-entry-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg><span>Daily Entry</span></a></li>
                <li><a href="#" class="nav-link" data-page="salaries-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg><span>Salaries</span></a></li>
                <li><a href="#" class="nav-link" data-page="agreements-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg><span>Agreements</span></a></li>
                <li><a href="#" class="nav-link" data-page="bonus-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg><span>Bonus</span></a></li>
                <li><a href="#" class="nav-link" data-page="arrears-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg><span>Arrears</span></a></li>
                <li><a href="#" class="nav-link" data-page="settings-page"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg><span>Settings</span></a></li>
            </ul>
            <div style="padding: 16px;"><button id="menu-logout-btn" class="btn secondary" style="width:100%;">Logout</button></div>
        </div>
        <header class="top-app-bar">
            <button id="menu-btn" class="icon-btn" onclick="toggleMenu()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
            <div id="header-title" class="app-bar-title"></div>
        </header>
        <main>
            <div class="page-content">
                <div id="daily-entry-page" class="page"></div>
                <div id="salaries-page" class="page"></div>
                <div id="agreements-page" class="page"></div>
                <div id="bonus-page" class="page"></div>
                <div id="arrears-page" class="page"></div>
                <div id="settings-page" class="page"></div>
                <div id="generate-payroll-page" class="page"></div>
                <div id="manage-workers-page" class="page"></div>
            </div>
        </main>
        <nav class="bottom-nav">
            <button class="bottom-nav-item" data-page="daily-entry-page"><span>Entry</span></button>
            <button class="bottom-nav-item" data-page="salaries-page"><span>Salaries</span></button>
            <button class="bottom-nav-item" data-page="bonus-page"><span>Bonus</span></button>
        </nav>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAya9Kjvrqrvpm7JuXU7aa_qyBrJKtjLyo",
            authDomain: "salary-d19b0.firebaseapp.com",
            databaseURL: "https://salary-d19b0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "salary-d19b0",
            storageBucket: "salary-d19b0.firebasestorage.app",
            messagingSenderId: "572149024584",
            appId: "1:572149024584:web:bbd70fc34d2ef11679d57d"
        };
        
        firebase.initializeApp(firebaseConfig);
        
        const auth = firebase.auth();
        const database = firebase.database();
        let workerList = [];
        let appConfig = { rates: null };
        
        // Cycle constants
        const WORK_CYCLE = 6;
        const REST_CYCLE = 2;
        let currentCycleDay = 1;
        let currentCycleType = 'work'; // 'work' or 'rest'

        const LOADER_HTML = `<div class="loader-container"><div class="loader"></div></div>`;

        function showSnackbar(message, type = 'info') {
            const snackbar = document.getElementById('snackbar');
            snackbar.textContent = message;
            snackbar.className = 'show';
            if (type === 'success') snackbar.classList.add('success');
            else if (type === 'error') snackbar.classList.add('error');
            setTimeout(() => { snackbar.className = snackbar.className.replace('show', ''); }, 3000);
        }
        
        function showConfirmationModal(message, onConfirm) {
            document.getElementById('modal-text').textContent = message;
            const modal = document.getElementById('confirmation-modal');
            modal.classList.remove('hidden');
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const confirmHandler = () => { onConfirm(); closeModal(); };
            const cancelHandler = () => closeModal();
            const closeModal = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };
            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);
        }

        document.getElementById('login-btn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(err => document.getElementById('auth-error').textContent = err.message));
        document.getElementById('signup-btn').addEventListener('click', () => auth.createUserWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(err => document.getElementById('auth-error').textContent = err.message));
        
        auth.onAuthStateChanged(async user => {
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            if (user) {
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                document.body.style.cursor = 'wait';
                await initializeApp();
                document.body.style.cursor = 'default';
            } else {
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        async function initializeApp() {
            setupAppListeners();
            await loadWorkers();
            await loadAgreements();
            await determineCurrentCycle(); // NEW: Determine current cycle state
            showPage('daily-entry-page');
        }

        function setupAppListeners() {
            document.querySelectorAll('.nav-link, .bottom-nav-item').forEach(link => {
                if (!link.getAttribute('listener-added')) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage(link.dataset.page);
                    });
                    link.setAttribute('listener-added', 'true');
                }
            });
            document.getElementById('menu-logout-btn').addEventListener('click', () => auth.signOut());
        }

        async function loadWorkers() {
            const uid = auth.currentUser.uid;
            const defaultWorkers = ["Khushi", "Anwar", "Mumtaz", "Ameer", "Nawaz", "Hussain", "Latif", "Rabdina"];
            try {
                const snapshot = await database.ref(`workers/${uid}`).once('value');
                if (snapshot.exists()) {
                    workerList = snapshot.val();
                    if(!Array.isArray(workerList)) throw new Error("Worker data is not an array");
                } else {
                    await database.ref(`workers/${uid}`).set(defaultWorkers);
                    workerList = defaultWorkers;
                }
            } catch (error) {
                console.error("Error loading workers:", error.message);
                workerList = defaultWorkers;
            }
        }
        
        // NEW FUNCTION: Determine current cycle state based on saved records
        async function determineCurrentCycle() {
            const uid = auth.currentUser.uid;
            try {
                const snapshot = await database.ref(`salaries/${uid}`).orderByKey().limitToLast(10).once('value');
                
                if (!snapshot.exists()) {
                    // No records found, start fresh
                    currentCycleDay = 1;
                    currentCycleType = 'work';
                    return;
                }
                
                // Get all records sorted by date (newest first)
                const records = snapshot.val();
                const sortedDates = Object.keys(records).sort((a, b) => new Date(b) - new Date(a));
                
                // Start from the most recent record
                let lastType = records[sortedDates[0]].type;
                let consecutiveDays = 1;
                
                // Count consecutive days of same type
                for (let i = 1; i < sortedDates.length; i++) {
                    const prevDate = new Date(sortedDates[i-1]);
                    const currDate = new Date(sortedDates[i]);
                    
                    // Check if dates are consecutive (difference of 1 day)
                    const diffDays = Math.round((prevDate - currDate) / (1000 * 60 * 60 * 24));
                    if (diffDays !== 1) break; // Not consecutive, stop counting
                    
                    if (records[sortedDates[i]].type === lastType) {
                        consecutiveDays++;
                    } else {
                        break;
                    }
                }
                
                // Determine cycle state based on last record type and consecutive days
                if (lastType === 'work') {
                    if (consecutiveDays >= WORK_CYCLE) {
                        currentCycleType = 'rest';
                        currentCycleDay = 1;
                    } else {
                        currentCycleType = 'work';
                        currentCycleDay = consecutiveDays + 1;
                    }
                } else if (lastType === 'rest') {
                    if (consecutiveDays >= REST_CYCLE) {
                        currentCycleType = 'work';
                        currentCycleDay = 1;
                    } else {
                        currentCycleType = 'rest';
                        currentCycleDay = consecutiveDays + 1;
                    }
                }
                
                console.log(`Determined cycle state: ${currentCycleType} day ${currentCycleDay}`);
                
            } catch (error) {
                console.error("Error determining cycle state:", error);
                // Fallback to default values
                currentCycleDay = 1;
                currentCycleType = 'work';
            }
        }

        async function loadAgreements() {
            const uid = auth.currentUser.uid;
            const getDefaultAgreements = () => JSON.parse(JSON.stringify({
                current: { tonRate: 22, restRate: 1100, layoffRate: 549, allowance: 20000 },
                new: { tonRate: 22, restRate: 1100, layoffRate: 549, allowance: 26000 }
            }));

            try {
                const snapshot = await database.ref(`agreements/${uid}`).once('value');
                if (snapshot.exists()) {
                    const dbRates = snapshot.val();
                    const finalRates = getDefaultAgreements();
                    if (dbRates && dbRates.current) {
                        Object.assign(finalRates.current, dbRates.current);
                    }
                    if (dbRates && dbRates.new) {
                        Object.assign(finalRates.new, dbRates.new);
                    }
                    appConfig.rates = finalRates;
                } else {
                    const defaultAgreements = getDefaultAgreements();
                    await database.ref(`agreements/${uid}`).set(defaultAgreements);
                    appConfig.rates = defaultAgreements;
                }
            } catch (error) {
                console.error("Agreements load karne mein masla:", error.message);
                showSnackbar('Agreements load nahi ho sake, default rates istemal kiye ja rahe hain.', 'error');
                appConfig.rates = getDefaultAgreements();
            }
        }
        
        function saveAgreement(type) {
            showConfirmationModal(`Are you sure you want to save the '${type}' agreement?`, async () => {
                const uid = auth.currentUser.uid;
                const data = {
                    tonRate: parseFloat(document.getElementById(`${type}TonRate`).value),
                    restRate: parseFloat(document.getElementById(`${type}RestRate`).value),
                    layoffRate: parseFloat(document.getElementById(`${type}LayoffRate`).value),
                    allowance: parseFloat(document.getElementById(`${type}Allowance`).value)
                };
                await database.ref(`agreements/${uid}/${type}`).update(data);
                showSnackbar(`${type.charAt(0).toUpperCase() + type.slice(1)} Agreement saved!`, 'success');
                await loadAgreements();
            });
        }

        function showPage(pageId, customTitle) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            const mainPageId = pageId.startsWith('generate-payroll') || pageId.startsWith('manage-workers') ? 'settings-page' : pageId;
            const pageLink = document.querySelector(`.nav-link[data-page="${mainPageId}"]`);
            document.getElementById('header-title').textContent = customTitle || (pageLink ? pageLink.querySelector('span').textContent : 'Salary Pro');
            document.querySelectorAll('.nav-link, .bottom-nav-item').forEach(link => {
                link.classList.toggle('active', link.dataset.page === mainPageId);
            });
            renderPageContent(pageId);
            targetPage.classList.add('active');
            if(document.getElementById('side-menu').classList.contains('open')) toggleMenu();
        }
        
        function renderPageContent(pageId) {
            const container = document.getElementById(pageId);
            if (!appConfig.rates || !workerList || workerList.length === 0) { 
                container.innerHTML = LOADER_HTML; return; 
            }
            let content = '';
            switch(pageId) {
                case 'daily-entry-page':
                    content = `<div class="grid-layout">
                        <div class="card">
                            <h2 class="card-title">Daily Work Record</h2>
                            <div class="cycle-indicator ${currentCycleType === 'work' ? 'cycle-work' : 'cycle-rest'}" id="cycle-indicator">
                                <div class="cycle-icon">${currentCycleDay}</div>
                                <span id="cycle-text">${currentCycleType === 'work' ? 'Work Day' : 'Rest Day'} - Day ${currentCycleDay}</span>
                            </div>
                            <input type="date" id="entryDate" class="form-select">
                            <div class="select-group"><select id="dayType" class="form-select"><option value="work">Work Day</option><option value="rest">Rest Day</option><option value="special_overtime">Special Overtime</option></select></div>
                            <div id="tonnage-section" class="form-group"><input type="number" id="tonnage" class="form-input" placeholder=" " required><label for="tonnage" class="form-label">Total Tonnage</label></div>
                            <h3 style="font-size: 16px; font-weight: 500; margin-top:24px;">Worker Attendance</h3>
                            <ul class="stagger-in" style="list-style:none; padding:0; max-height:200px; overflow-y:auto;">${workerList.map(w => `<li><label style="display:flex; align-items:center; width:100%; padding: 4px 0;"><input type="checkbox" class="worker-checkbox" checked value="${w}"> <span style="margin-left:8px;">${w}</span></label></li>`).join('')}</ul>
                            <button class="btn accent" onclick="confirmAndSaveDailyEntry()" style="width:100%; margin-top: 16px;">Calculate & Save</button>
                        </div>
                        <div class="card" id="history-card-for-desktop">
                           <h2 class="card-title">Daily History</h2>
                           <div class="select-group" style="margin-bottom: 16px;">
                               <select id="historyPeriodSelect" class="form-select" title="Select period to view history"></select>
                           </div>
                           <div id="history-table-container"></div>
                        </div></div>`;
                    container.innerHTML = content;
                    applyStaggerAnimation('.stagger-in');
                    document.getElementById('entryDate').valueAsDate = new Date();
                    
                    // Set day type based on current cycle
                    if (currentCycleType === 'rest') {
                        document.getElementById('dayType').value = 'rest';
                        document.getElementById('tonnage-section').style.display = 'none';
                    } else {
                        document.getElementById('dayType').value = 'work';
                        document.getElementById('tonnage-section').style.display = 'block';
                    }
                    
                    document.getElementById('dayType').addEventListener('change', () => {
                        const dayType = document.getElementById('dayType').value;
                        document.getElementById('tonnage-section').style.display = dayType === 'rest' ? 'none' : 'block';
                    });
                    
                    initializeHistoryView(); 
                    setupDailyEntryPage();
                    break;
                case 'salaries-page':
                    content = `
                        <div id="current-expected-salary-card"></div>
                        <div class="card">
                            <h2 class="card-title">Guzishta Salary Records</h2>
                            <p style="color: var(--md-text-secondary); font-size: 14px;">Guzishta records dekhne ke liye neeche diye gaye menu se muddat (period) select karein.</p>
                            <div class="select-group" style="margin-bottom: 16px;">
                                <select id="salariesPeriodSelect" class="form-select" title="Select period to view salaries"></select>
                            </div>
                            <div id="salaries-table-container">${LOADER_HTML}</div>
                        </div>`;
                    container.innerHTML = content;
                    initializeSalariesView();
                    renderCurrentExpectedSalary();
                    break;
                case 'agreements-page':
                    content = `<div class="grid-layout">
                        <div class="card"><h2 class="card-title">Current Agreement</h2>
                            <div class="form-group"><input type="number" id="currentTonRate" value="${appConfig.rates.current.tonRate}" class="form-input" placeholder=" "><label class="form-label">Ton Rate</label></div>
                            <div class="form-group"><input type="number" id="currentRestRate" value="${appConfig.rates.current.restRate}" class="form-input" placeholder=" "><label class="form-label">Rest Rate</label></div>
                            <div class="form-group"><input type="number" id="currentLayoffRate" value="${appConfig.rates.current.layoffRate}" class="form-input" placeholder=" "><label class="form-label">Layoff Rate</label></div>
                            <div class="form-group"><input type="number" id="currentAllowance" value="${appConfig.rates.current.allowance}" class="form-input" placeholder=" "><label class="form-label">Monthly Allowance</label></div>
                            <button class="btn primary" style="width:100%" onclick="saveAgreement('current')">Save Current</button>
                        </div>
                        <div class="card"><h2 class="card-title">New Agreement</h2>
                            <div class="form-group"><input type="number" id="newTonRate" value="${appConfig.rates.new.tonRate}" class="form-input" placeholder=" "><label class="form-label">Ton Rate</label></div>
                            <div class="form-group"><input type="number" id="newRestRate" value="${appConfig.rates.new.restRate}" class="form-input" placeholder=" "><label class="form-label">Rest Rate</label></div>
                            <div class="form-group"><input type="number" id="newLayoffRate" value="${appConfig.rates.new.layoffRate}" class="form-input" placeholder=" "><label class="form-label">Layoff Rate</label></div>
                            <div class="form-group"><input type="number" id="newAllowance" value="${appConfig.rates.new.allowance}" class="form-input" placeholder=" "><label class="form-label">Monthly Allowance</label></div>
                            <button class="btn primary" style="width:100%" onclick="saveAgreement('new')">Save New</button>
                        </div></div>`;
                    container.innerHTML = content;
                    break;
                case 'bonus-page':
                    content = `<div class="card">
                        <h2 class="card-title">Annual Bonus & Gratuity Calculator</h2>
                        <p style="color: var(--md-text-secondary); font-size: 14px;">Bonus ki calculation fiscal year (10 Oct se 9 Oct) ke hisab se ki jayegi.</p>
                        <label>Fiscal Year Select Karein</label>
                        <div class="select-group"><select id="bonusYearSelect" class="form-select"></select></div>
                        <button onclick="calculateBonus()" class="btn accent" style="width:100%">Calculate Bonus</button>
                        <pre id="bonusResult" style="margin-top:16px; padding:12px; background: #f5f5f5; border-radius: 4px;"></pre>
                    </div>`;
                    container.innerHTML = content;
                    populateBonusYearSelector();
                    break;
                case 'arrears-page':
                    content = `<div class="card">
                        <h2 class="card-title">Naye Agreement Ke Mutabiq Aaj Tak Ka Arrear</h2>
                        <pre id="automaticArrearsResult" style="margin-top:16px; padding:12px; background: #f5f5f5; border-radius: 4px; font-weight: 500;">Calculating...</pre>
                        <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--md-divider-color);">
                        <h2 class="card-title">Makhsoos Muddat Ka Arrear Nikalein</h2>
                        <p style="color: var(--md-text-secondary); font-size: 14px;">This re-calculates every single day's earning based on the difference between the 'Current' and 'New' agreements.</p>
                        <label>Select Period for Arrears Calculation</label>
                        <div class="form-group"><input type="date" id="arrearsStartDate" class="form-select"></div>
                        <div class="form-group"><input type="date" id="arrearsEndDate" class="form-select"></div>
                        <button onclick="calculateTrueArrears()" class="btn accent" style="width:100%">Calculate True Arrears</button>
                        <pre id="arrearsResult" style="margin-top:16px; padding:12px; background: #f5f5f5; border-radius: 4px;"></pre></div>`;
                    container.innerHTML = content;
                    calculateAutomaticArrears();
                    break;
                case 'settings-page':
                    content = `<div class="card" style="padding:0;">
                        <div class="settings-item" onclick="showPage('generate-payroll-page', 'Generate Payroll')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                            <span>Generate Payroll</span>
                        </div>
                        <div class="settings-item" onclick="showPage('manage-workers-page', 'Manage Workers')">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            <span>Manage Workers</span>
                        </div>
                    </div>`;
                    container.innerHTML = content;
                    break;
                case 'generate-payroll-page':
                    const monthlyAllowance = appConfig.rates.current.allowance;
                    content = `<div class="card">
                        <p style="font-size: 14px;">Uses <b>Current Agreement</b> rates. Monthly Allowance is <b>Rs ${monthlyAllowance}</b>. Code har 15 din ke hisab se adha (1/2) allowance shamil karega.</p>
                        <div class="form-group"><input type="date" id="payrollStartDate" class="form-select"></div>
                        <div class="form-group"><input type="date" id="payrollEndDate" class="form-select"></div>
                        <button onclick="generatePayroll()" class="btn accent" style="width:100%">Generate</button>
                        <pre id="payrollResult" style="margin-top:16px; padding: 12px; background: #f5f5f5; border-radius: 4px;"></pre>
                    </div>`;
                    container.innerHTML = content;
                    break;
                case 'manage-workers-page':
                    let workerInputsHTML = workerList.map((name, index) => {
                        return `<div class="form-group">
                                    <input type="text" id="worker-name-${index}" class="form-input" value="${name}" placeholder=" " required>
                                    <label class="form-label" for="worker-name-${index}">Worker ${index + 1} Name</label>
                                </div>`;
                    }).join('');

                    content = `<div class="card">
                        <p style="font-size: 14px; color: var(--md-text-secondary);">Yahan se aap apne workers ke naam tabdeel kar sakte hain. Khali chhorne par worker list se nikal jayega.</p>
                        ${workerInputsHTML}
                        <button onclick="saveWorkerNames()" class="btn primary" style="width:100%; margin-top: 16px;">Save Worker Names</button>
                      </div>`;
                    container.innerHTML = content;
                    break;
            }
        }
        
        function toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); document.getElementById('overlay').classList.toggle('hidden'); }

        function _calculateSingleDay(record, agreementRates) {
            const { tonRate, restRate, layoffRate } = agreementRates;
            const { type, tonnage } = record;
            const present = Array.isArray(record.presentWorkers) ? record.presentWorkers : [];
            const presentCount = present.length > 0 ? present.length : (record.presentCount || 0);
            let dailyEarnings = {};
            workerList.forEach(w => dailyEarnings[w] = 0);
            if (presentCount === 0 && type !== 'rest') {
                workerList.forEach(w => dailyEarnings[w] = layoffRate);
                return dailyEarnings;
            }
            if (type === 'work' && presentCount > 0) {
                let perWorker = (tonnage * tonRate) / presentCount;
                if (perWorker < layoffRate) perWorker = layoffRate;
                workerList.forEach(w => { dailyEarnings[w] = present.includes(w) ? perWorker : layoffRate; });
            } else if (type === 'rest') {
                workerList.forEach(w => { dailyEarnings[w] = restRate; });
            } else if (type === 'special_overtime' && presentCount > 0) {
                const baseEarningPerWorker = (tonnage * tonRate) / presentCount;
                let perWorkerPay;
                if (baseEarningPerWorker < layoffRate) {
                    perWorkerPay = (layoffRate * 2) + layoffRate;
                } else {
                    perWorkerPay = (baseEarningPerWorker * 2) + layoffRate;
                }
                workerList.forEach(w => { dailyEarnings[w] = present.includes(w) ? perWorkerPay : layoffRate; });
            }
            return dailyEarnings;
        }

        function confirmAndSaveDailyEntry() {
            showConfirmationModal('Are you sure you want to save this daily entry?', calculateAndSave);
        }

        async function calculateAndSave() {
            if (!appConfig.rates) { showSnackbar("Data not ready. Please wait.", 'error'); return; }
            const date = document.getElementById('entryDate').value;
            if (!date) { showSnackbar("Please select a date.", 'error'); return; }
            const dayType = document.getElementById('dayType').value;
            const tonnage = parseFloat(document.getElementById('tonnage').value) || 0;
            const presentWorkers = Array.from(document.querySelectorAll('.worker-checkbox:checked')).map(cb => cb.value);
            if (presentWorkers.length === 0 && dayType !== 'rest') { showSnackbar("Select present workers for a work day.", 'error'); return; }
            
            const recordDataForCalc = { type: dayType, tonnage, presentWorkers };
            const earnings = _calculateSingleDay(recordDataForCalc, appConfig.rates.current);
            const perWorkerEarning = presentWorkers.length > 0 ? (earnings[presentWorkers[0]] || 0) : 0;
            
            const recordToSave = { 
                date, 
                type: dayType, 
                tonnage, 
                presentCount: presentWorkers.length, 
                presentWorkers, 
                earnings, 
                perWorkerEarning 
            };
            
            // Save the record
            await database.ref(`salaries/${auth.currentUser.uid}/${date}`).set(recordToSave);
            
            // Update cycle for next day
            updateCycleState(dayType);
            
            showSnackbar('Daily entry saved successfully!', 'success');
            loadHistory();
        }
        
        // UPDATED FUNCTION: Update cycle state after saving
        function updateCycleState(dayType) {
            if (dayType === 'work') {
                if (currentCycleType === 'work') {
                    if (currentCycleDay < WORK_CYCLE) {
                        currentCycleDay++;
                    } else {
                        currentCycleType = 'rest';
                        currentCycleDay = 1;
                    }
                } else {
                    // If work day during rest cycle, reset to work cycle
                    currentCycleType = 'work';
                    currentCycleDay = 1;
                }
            } else if (dayType === 'rest') {
                if (currentCycleType === 'rest') {
                    if (currentCycleDay < REST_CYCLE) {
                        currentCycleDay++;
                    } else {
                        currentCycleType = 'work';
                        currentCycleDay = 1;
                    }
                } else {
                    // If rest day during work cycle, reset to rest cycle
                    currentCycleType = 'rest';
                    currentCycleDay = 1;
                }
            }
            
            // Update UI indicator
            updateCycleIndicator();
        }
        
        // NEW FUNCTION: Update the cycle indicator UI
        function updateCycleIndicator() {
            const cycleText = document.getElementById('cycle-text');
            const cycleIndicator = document.getElementById('cycle-indicator');
            
            if (cycleText && cycleIndicator) {
                cycleText.textContent = `${currentCycleType === 'work' ? 'Work Day' : 'Rest Day'} - Day ${currentCycleDay}`;
                cycleIndicator.className = `cycle-indicator ${currentCycleType === 'work' ? 'cycle-work' : 'cycle-rest'}`;
                
                // Update the cycle icon number
                const cycleIcon = cycleIndicator.querySelector('.cycle-icon');
                if (cycleIcon) {
                    cycleIcon.textContent = currentCycleDay;
                }
            }
            
            // Set day type based on current cycle
            const dayTypeSelect = document.getElementById('dayType');
            if (dayTypeSelect) {
                if (currentCycleType === 'rest') {
                    dayTypeSelect.value = 'rest';
                    document.getElementById('tonnage-section').style.display = 'none';
                } else {
                    dayTypeSelect.value = 'work';
                    document.getElementById('tonnage-section').style.display = 'block';
                }
            }
        }
        
        // NEW FUNCTION: Setup daily entry page with cycle and auto-fill
        async function setupDailyEntryPage() {
            try {
                // Update UI indicator
                updateCycleIndicator();
                
                // Auto-fill missing days
                await fillMissingDays();
            } catch (error) {
                console.error("Setup daily entry error:", error);
                showSnackbar("Error setting up daily entry page", 'error');
            }
        }
        
        // NEW FUNCTION: Fill missing days with 1-ton entries
        async function fillMissingDays() {
            try {
                const uid = auth.currentUser.uid;
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                // Get the last saved date
                const lastRecordSnapshot = await database.ref(`salaries/${uid}`).orderByKey().limitToLast(1).once('value');
                let lastDate = null;
                
                if (lastRecordSnapshot.exists()) {
                    const lastRecordKey = Object.keys(lastRecordSnapshot.val())[0];
                    lastDate = new Date(lastRecordKey);
                } else {
                    // If no records, start from yesterday
                    lastDate = new Date();
                    lastDate.setDate(lastDate.getDate() - 1);
                }
                
                // Calculate days to fill
                const daysToFill = [];
                const currentDate = new Date(lastDate);
                currentDate.setDate(currentDate.getDate() + 1); // Start from next day
                
                while (currentDate < today) {
                    daysToFill.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Create entries for missing days
                for (const date of daysToFill) {
                    const dateStr = date.toISOString().split('T')[0];
                    const record = {
                        date: dateStr,
                        type: 'work',
                        tonnage: 1, // Default 1 ton for missing days
                        presentWorkers: [],
                        presentCount: 0,
                        isAutoGenerated: true
                    };
                    
                    // Calculate earnings
                    const earnings = _calculateSingleDay(record, appConfig.rates.current);
                    record.earnings = earnings;
                    record.perWorkerEarning = appConfig.rates.current.layoffRate;
                    
                    // Save to database
                    await database.ref(`salaries/${uid}/${dateStr}`).set(record);
                }
                
                if (daysToFill.length > 0) {
                    showSnackbar(`${daysToFill.length} missing days filled with 1-ton entries`, 'success');
                    loadHistory();
                }
            } catch (error) {
                console.error("Error filling missing days:", error);
                showSnackbar("Error filling missing days", 'error');
            }
        }

        function isLastDayOfMonth(dt) {
            const test = new Date(dt.getTime());
            test.setDate(test.getDate() + 1);
            return test.getDate() === 1;
        }
        
        function countAllowancesInRange(startDateStr, endDateStr) {
            if (!startDateStr || !endDateStr) return 0;
            const start = new Date(startDateStr + "T00:00:00");
            const end = new Date(endDateStr + "T00:00:00");
            let allowanceCount = 0;
            let cursor = new Date(start.getTime());
            while (cursor <= end) {
                if (cursor.getDate() === 15) { allowanceCount++; } 
                else if (isLastDayOfMonth(cursor)) { allowanceCount++; }
                cursor.setDate(cursor.getDate() + 1);
            }
            return allowanceCount;
        }
        
        function generatePayroll() {
            if (!appConfig.rates) { showSnackbar("Data is not ready yet.", 'error'); return; }
            const startDateStr = document.getElementById('payrollStartDate').value;
            const endDateStr = document.getElementById('payrollEndDate').value;
            if (!startDateStr || !endDateStr) { showSnackbar("Please select both a start and end date.", 'error'); return; }
            const resultElem = document.getElementById('payrollResult');
            resultElem.innerText = 'Generating payroll...';
            database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(startDateStr).endAt(endDateStr).once('value', snapshot => {
                let payroll = {}; workerList.forEach(w => { payroll[w] = 0; });
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const record = child.val();
                        if (record && record.earnings) {
                            workerList.forEach(w => { payroll[w] += record.earnings[w] || 0; });
                        }
                    });
                }
                const numAllowances = countAllowancesInRange(startDateStr, endDateStr);
                const monthlyAllowance = appConfig.rates.current.allowance || 0;
                const allowancePerPeriod = monthlyAllowance / 2;
                const totalAllowance = numAllowances * allowancePerPeriod;
                let detailsPerWorker = '';
                workerList.forEach(w => {
                    const dailyPay = payroll[w];
                    const finalPay = dailyPay + totalAllowance;
                    detailsPerWorker += `${w.padEnd(10)}: Rs ${dailyPay.toFixed(2)} (Earned) + Rs ${totalAllowance.toFixed(2)} (Allowance) = Rs ${finalPay.toFixed(2)}\n`;
                });
                let resultText = `PAYROLL: ${startDateStr} to ${endDateStr}\n\n`;
                resultText += `Allowance Calculation:\n`;
                resultText += `  - Pay Events Detected: ${numAllowances}\n`;
                resultText += `  - Allowance Per Event: Rs ${allowancePerPeriod.toFixed(2)}\n`;
                resultText += `  - Total Allowance (per worker): Rs ${totalAllowance.toFixed(2)}\n`;
                resultText += `-------------------------------------------\n\n`;
                resultText += `Worker Salaries:\n${detailsPerWorker}\n`;
                resultText += `-------------------------------------------\n`;
                resultElem.innerText = resultText;
            });
        }
        
        function loadHistory() {
            const container = document.getElementById('history-table-container');
            if (!container) return;
            const selectedPeriod = document.getElementById('historyPeriodSelect').value;
            if (!selectedPeriod) { container.innerHTML = "<p>Please select a period to view history.</p>"; return; }
            container.innerHTML = LOADER_HTML;
            const [year, month, day] = selectedPeriod.split('-').map(Number);
            let startDate, endDate;
            if (day === 1) { startDate = selectedPeriod; endDate = `${year}-${String(month).padStart(2, '0')}-15`; } 
            else { startDate = selectedPeriod; const lastDayOfMonth = new Date(year, month, 0).getDate(); endDate = `${year}-${String(month).padStart(2, '0')}-${lastDayOfMonth}`; }
            database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(startDate).endAt(endDate).once('value', snapshot => {
                if (!snapshot.exists()) { container.innerHTML = "<p>No daily records found for this period.</p>"; return; }
                let rows = '';
                const records = snapshot.val();
                const sortedKeys = Object.keys(records).sort((a, b) => new Date(b) - new Date(a));
                sortedKeys.forEach(key => {
                    const rec = records[key];
                    const presentCount = rec.presentCount !== undefined ? `${rec.presentCount}/${workerList.length}` : 'N/A';
                    rows += `<tr><td>${rec.date}</td><td>${rec.type}</td><td>${presentCount}</td><td>${(rec.perWorkerEarning || 0).toFixed(2)}</td></tr>`;
                });
                container.innerHTML = `<table style="width:100%; border-collapse:collapse;"><thead><tr><th>Date</th><th>Type</th><th>Present</th><th>Earning</th></tr></thead><tbody>${rows}</tbody></table>`;
            });
        }
        
        async function calculateAutomaticArrears() {
            const resultElem = document.getElementById('automaticArrearsResult');
            if (!resultElem) return;
            resultElem.innerText = 'Calculating...';
            const ARREARS_START_DATE = '2023-10-10';
            const today = new Date();
            const end = today.toISOString().split('T')[0];
            const snapshot = await database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(ARREARS_START_DATE).endAt(end).once('value');
            if (!snapshot.exists()) {
                resultElem.innerText = `No records found from ${ARREARS_START_DATE} to Today.`;
                return;
            }
            let actualTotals = {}; workerList.forEach(w => actualTotals[w] = 0);
            let hypotheticalTotals = {}; workerList.forEach(w => hypotheticalTotals[w] = 0);
            snapshot.forEach(child => {
                const record = child.val();
                if (record && record.earnings) {
                    const oldEarnings = record.earnings;
                    const newEarnings = _calculateSingleDay(record, appConfig.rates.new);
                    workerList.forEach(w => {
                        actualTotals[w] += oldEarnings[w] || 0;
                        hypotheticalTotals[w] += newEarnings[w] || 0;
                    });
                }
            });
            const numAllowances = countAllowancesInRange(ARREARS_START_DATE, end);
            const currentAllowancePerPeriod = (appConfig.rates.current.allowance || 0) / 2;
            const newAllowancePerPeriod = (appConfig.rates.new.allowance || 0) / 2;
            const allowanceArrears = numAllowances * (newAllowancePerPeriod - currentAllowancePerPeriod);
            let resultText = `Arrears from ${ARREARS_START_DATE} to ${end}\n`;
            resultText += `--------------------------------------\n`;
            workerList.forEach(w => {
                const dailyArrears = hypotheticalTotals[w] - actualTotals[w];
                const totalArrearsPerWorker = dailyArrears + allowanceArrears;
                resultText += `${w.padEnd(10)}: Rs ${totalArrearsPerWorker.toFixed(2)}\n`;
            });
            resultElem.innerText = resultText;
        }

        async function calculateTrueArrears() {
            const resultElem = document.getElementById('arrearsResult');
            resultElem.innerText = 'Calculating... Fetching records...';
            const start = document.getElementById('arrearsStartDate').value;
            const end = document.getElementById('arrearsEndDate').value;
            if(!start || !end) { resultElem.innerText = 'Please select dates.'; return; }
            const snapshot = await database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(start).endAt(end).once('value');
            if (!snapshot.exists()) { resultElem.innerText = 'No records in period.'; return; }
            let actualTotals = {}; workerList.forEach(w => actualTotals[w] = 0);
            let hypotheticalTotals = {}; workerList.forEach(w => hypotheticalTotals[w] = 0);
            snapshot.forEach(child => {
                const record = child.val();
                if (record && record.earnings) {
                    const oldEarnings = record.earnings;
                    const newEarnings = _calculateSingleDay(record, appConfig.rates.new);
                    workerList.forEach(w => {
                        actualTotals[w] += oldEarnings[w] || 0;
                        hypotheticalTotals[w] += newEarnings[w] || 0;
                    });
                }
            });
            const numAllowances = countAllowancesInRange(start, end);
            const currentAllowancePerPeriod = (appConfig.rates.current.allowance || 0) / 2;
            const newAllowancePerPeriod = (appConfig.rates.new.allowance || 0) / 2;
            const allowanceArrears = numAllowances * (newAllowancePerPeriod - currentAllowancePerPeriod);
            let resultText = `TRUE ARREARS: ${start} to ${end}\n`;
            resultText += `Pay Events Detected: ${numAllowances}\n-----------------------------------\n\n`;
            workerList.forEach(w => {
                const dailyArrears = hypotheticalTotals[w] - actualTotals[w];
                const totalArrears = dailyArrears + allowanceArrears;
                resultText += `${w.padEnd(10)}:\n`;
                resultText += `  Daily Pay Arrears: Rs ${dailyArrears.toFixed(2)}\n`;
                resultText += `  Allowance Arrears: Rs ${allowanceArrears.toFixed(2)}\n`;
                resultText += `  >> TOTAL ARREARS: Rs ${totalArrears.toFixed(2)} <<\n\n`;
            });
            resultElem.innerText = resultText;
        }

        function initializeHistoryView() {
            populateHistorySelector(); 
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const selector = document.getElementById('historyPeriodSelect');
            if (selector){
                 if (day <= 15) { selector.value = `${year}-${String(month).padStart(2, '0')}-01`; } 
                 else { selector.value = `${year}-${String(month).padStart(2, '0')}-16`; }
                selector.addEventListener('change', loadHistory); 
                loadHistory(); 
            }
        }

        function populateHistorySelector() {
            const select = document.getElementById('historyPeriodSelect');
            if (!select) return;
            select.innerHTML = '';
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let currentDate = new Date();
            currentDate.setDate(1); 
            for (let i = 0; i < 24; i++) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                let option2 = document.createElement('option');
                option2.value = `${year}-${String(month + 1).padStart(2, '0')}-16`; 
                option2.textContent = `${monthNames[month]} ${year} - (16 se Aakhir Tak)`;
                select.appendChild(option2);
                let option1 = document.createElement('option');
                option1.value = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                option1.textContent = `${monthNames[month]} ${year} - (1 se 15 Tak)`;
                select.appendChild(option1);
                currentDate.setMonth(currentDate.getMonth() - 1);
            }
        }
        
        async function renderCurrentExpectedSalary() {
            const container = document.getElementById('current-expected-salary-card');
            if (!container) return;
            container.innerHTML = `<div class="card">${LOADER_HTML}</div>`;
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            let startDate, endDate, periodTitle;
            if (day <= 15) {
                startDate = `${year}-${String(month).padStart(2, '0')}-01`;
                endDate = `${year}-${String(month).padStart(2, '0')}-15`;
                periodTitle = `Mojooda Expected Salary (1 se 15 Tak)`;
            } else {
                startDate = `${year}-${String(month).padStart(2, '0')}-16`;
                const lastDayOfMonth = new Date(year, month, 0).getDate();
                endDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDayOfMonth).padStart(2, '0')}`;
                periodTitle = `Mojooda Expected Salary (16 se Aakhir Tak)`;
            }
            try {
                const snapshot = await database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(startDate).endAt(endDate).once('value');
                let periodSalaries = {};
                workerList.forEach(w => periodSalaries[w] = 0);
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const record = child.val();
                        if (record && record.earnings) {
                            workerList.forEach(w => { periodSalaries[w] += record.earnings[w] || 0; });
                        }
                    });
                }
                const allowance = (appConfig.rates.current.allowance || 0) / 2;
                let salaryListHTML = '<ul style="list-style:none; padding: 0; margin:0;">';
                workerList.forEach(w => {
                    const finalPay = periodSalaries[w] + allowance;
                    salaryListHTML += `<li style="display:flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                        <span>${w}</span>
                        <span style="font-weight: 500; color: var(--md-primary-color);">Rs ${finalPay.toFixed(2)}</span>
                    </li>`;
                });
                salaryListHTML += '</ul>';
                container.innerHTML = `<div class="card"><h2 class="card-title">${periodTitle}</h2>${salaryListHTML}</div>`;
            } catch(error) {
                container.innerHTML = `<div class="card"><p style="color:red;">Error loading current salary: ${error.message}</p></div>`;
            }
        }
        
        function initializeSalariesView() {
            populateSalariesPeriodSelector(); 
            const selector = document.getElementById('salariesPeriodSelect');
            if (selector){
                selector.addEventListener('change', renderSalariesTable); 
                renderSalariesTable();
            }
        }

        function populateSalariesPeriodSelector() {
            const select = document.getElementById('salariesPeriodSelect');
            if (!select) return;
            select.innerHTML = '';
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            let currentDate = new Date();
            currentDate.setDate(1);
            for (let i = 0; i < 24; i++) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                let option2 = document.createElement('option');
                option2.value = `${year}-${String(month + 1).padStart(2, '0')}-16`; 
                option2.textContent = `${monthNames[month]} ${year} - (16 se Aakhir Tak)`;
                select.appendChild(option2);
                let option1 = document.createElement('option');
                option1.value = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                option1.textContent = `${monthNames[month]} ${year} - (1 se 15 Tak)`;
                select.appendChild(option1);
                currentDate.setMonth(currentDate.getMonth() - 1);
            }
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            if (day <= 15) { select.value = `${year}-${String(month).padStart(2, '0')}-01`; } 
            else { select.value = `${year}-${String(month).padStart(2, '0')}-16`; }
        }

        async function renderSalariesTable() {
            const container = document.getElementById('salaries-table-container');
            if (!container) return;
            const selectedPeriod = document.getElementById('salariesPeriodSelect').value;
            if (!selectedPeriod) { container.innerHTML = "<p>Please select a period to view salaries.</p>"; return; }
            container.innerHTML = LOADER_HTML;
            const [year, month, day] = selectedPeriod.split('-').map(Number);
            let startDate, endDate;
            if (day === 1) { startDate = selectedPeriod; endDate = `${year}-${String(month).padStart(2, '0')}-15`; } 
            else { startDate = selectedPeriod; const lastDayOfMonth = new Date(year, month, 0).getDate(); endDate = `${year}-${String(month).padStart(2, '0')}-${String(lastDayOfMonth).padStart(2, '0')}`; }
            try {
                const snapshot = await database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(startDate).endAt(endDate).once('value');
                let tableHTML = `<p>No salary records found for this period.</p>`;
                let summaryHTML = '';
                if (snapshot.exists()) {
                    let tableRowsHTML = '';
                    let periodSalaries = {};
                    workerList.forEach(w => periodSalaries[w] = 0);
                    const records = snapshot.val();
                    const sortedKeys = Object.keys(records).sort((a, b) => new Date(a) - new Date(b));
                    sortedKeys.forEach(dateKey => {
                        const rec = records[dateKey];
                        const payment = rec.perWorkerEarning || 0;
                        let typeDisplay = rec.type;
                        if (rec.type === 'work') typeDisplay = `<svg title="Work Day" style="vertical-align: middle; margin-right: 4px;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg> Work`;
                        if (rec.type === 'rest') typeDisplay = `<svg title="Rest Day" style="vertical-align: middle; margin-right: 4px;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg> Rest`;
                        if (rec.type === 'special_overtime') typeDisplay = `<svg title="Overtime" style="vertical-align: middle; margin-right: 4px;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> OT`;
                        const presentCount = rec.presentCount !== undefined ? rec.presentCount : 'N/A';
                        if (rec && rec.earnings) {
                            workerList.forEach(w => { periodSalaries[w] += rec.earnings[w] || 0; });
                        }
                        tableRowsHTML += `<tr><td>${new Date(rec.date + 'T00:00:00').toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit'})}</td><td>${typeDisplay}</td><td>${rec.tonnage || '--'}</td><td>${presentCount}</td><td>${payment.toFixed(2)}</td></tr>`;
                    });
                    tableHTML = `<style>.salaries-table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px; }.salaries-table th, .salaries-table td { padding: 8px 12px; border: 1px solid var(--md-divider-color); text-align: left; vertical-align: middle; }.salaries-table thead { background-color: #f0f0f0; }.salaries-table th { font-weight: 500; }.salaries-table td:nth-child(n+3) { text-align: right; }</style><table class="salaries-table"><thead><tr><th>Date</th><th>Type</th><th>Tons</th><th>Workers</th><th>Payment/Day</th></tr></thead><tbody>${tableRowsHTML}</tbody></table>`;
                    const allowance = (appConfig.rates.current.allowance || 0) / 2;
                    let salaryListHTML = '<ul style="list-style:none; padding: 0; margin:0;">';
                    workerList.forEach(w => {
                        const finalPay = periodSalaries[w] + allowance;
                        salaryListHTML += `<li style="display:flex; flex-wrap:wrap; justify-content: space-between; align-items:center; padding: 10px 4px; border-bottom: 1px solid #eee;">
                            <span style="font-weight: 500; margin-right:12px;">${w}:</span>
                            <span style="font-size:12px; color:#555">Rs ${periodSalaries[w].toFixed(2)} + Rs ${allowance.toFixed(2)} =</span>
                            <span style="font-weight: bold; color:var(--md-accent-color); font-size: 16px;">Rs ${finalPay.toFixed(2)}</span>
                        </li>`;
                    });
                    salaryListHTML += '</ul>';
                    summaryHTML = `<div class="card" style="margin-top:24px;"><h3 class="card-title" style="font-size:16px; margin-bottom:16px;">Salary Summary (with Allowance)</h3>${salaryListHTML}</div>`;
                }
                container.innerHTML = tableHTML + summaryHTML;
            } catch (error) {
                container.innerHTML = `<p style="color: red;">Error loading data: ${error.message}</p>`;
                console.error("Error in renderSalariesTable:", error);
            }
        }
        
        function populateBonusYearSelector() {
            const select = document.getElementById('bonusYearSelect');
            if (!select) return;
            select.innerHTML = '';
            let currentYear = new Date().getFullYear();
            const today = new Date();
            if (today.getMonth() < 9 || (today.getMonth() === 9 && today.getDate() < 10)) { currentYear--; }
            for (let i = 0; i < 5; i++) {
                const year = currentYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `Oct ${year} - Oct ${year + 1}`;
                select.appendChild(option);
            }
        }

        async function calculateBonus() {
            const resultElem = document.getElementById('bonusResult');
            const bonusYearSelect = document.getElementById('bonusYearSelect');
            if (!bonusYearSelect.value) { resultElem.innerText = 'Please select a fiscal year.'; return; }
            resultElem.innerText = 'Calculating... Fetching yearly records...';
            const startYear = parseInt(bonusYearSelect.value);
            const startDate = `${startYear}-10-10`;
            const endDate = `${startYear + 1}-10-09`;
            const snapshot = await database.ref(`salaries/${auth.currentUser.uid}`).orderByChild('date').startAt(startDate).endAt(endDate).once('value');
            if (!snapshot.exists()) { resultElem.innerText = `No records found for the fiscal year ${startYear}-${startYear + 1}.`; return; }
            let yearlyEarnings = {}; workerList.forEach(w => { yearlyEarnings[w] = 0; });
            snapshot.forEach(child => {
                const record = child.val();
                if(record && record.earnings) {
                    workerList.forEach(w => { yearlyEarnings[w] += record.earnings[w] || 0; });
                }
            });
            const monthlyAllowance = appConfig.rates.current.allowance || 0;
            const totalAllowancePerWorker = monthlyAllowance * 12;
            let resultText = `BONUS & GRATUITY\nFiscal Year: ${startDate} to ${endDate}\n`;
            resultText += `--------------------------------------\n\n`;
            workerList.forEach(w => {
                const totalYearlyPay = yearlyEarnings[w] + totalAllowancePerWorker;
                const averageMonthlySalary = totalYearlyPay / 12;
                const gratuity = averageMonthlySalary;
                const totalBonus = averageMonthlySalary + gratuity;
                resultText += `${w.padEnd(10)}:\n`;
                resultText += `  Yearly Pay (inc. allowance): Rs ${totalYearlyPay.toFixed(2)}\n`;
                resultText += `  Avg Monthly Salary:          Rs ${averageMonthlySalary.toFixed(2)}\n`;
                resultText += `  Gratuity Amount:             Rs ${gratuity.toFixed(2)}\n`;
                resultText += `  >> TOTAL BONUS PAYABLE:      Rs ${totalBonus.toFixed(2)} <<\n\n`;
            });
            resultElem.innerText = resultText;
        }
        
        function applyStaggerAnimation(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            const items = Array.from(container.children);
            items.forEach((item, i) => {
                setTimeout(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                }, 70 * i);
            });
        }

        async function saveWorkerNames() {
            const uid = auth.currentUser.uid;
            const newWorkerList = [];
            for (let i = 0; i < workerList.length; i++) {
                const input = document.getElementById(`worker-name-${i}`);
                if (input && input.value.trim() !== '') {
                    newWorkerList.push(input.value.trim());
                }
            }
            if (newWorkerList.length === 0) {
                showSnackbar("Kam az kam ek worker ka naam zaroori hai", 'error');
                return;
            }
            try {
                await database.ref(`workers/${uid}`).set(newWorkerList);
                workerList = newWorkerList;
                showSnackbar("Worker list update ho gayi!", 'success');
            } catch (error) {
                showSnackbar(`Worker list save karne mein masla: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
